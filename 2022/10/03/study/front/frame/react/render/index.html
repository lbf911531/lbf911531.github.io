<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.5.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="在探究render源码之前，首先对React v16.8需要简单认知一下； 在整个render过程中，其实分为两步骤：  render  commit 这里说的render函数只是开启上方两个环节的一个入口；   章节3.Fiber.md 中有提到： ​    react 的render阶段会将ReactElement对象，也就是虚拟节点对象；基于每一个ReactElement分割成一个一个的小任">
<meta property="og:type" content="article">
<meta property="og:title" content="React.render的第一次研究">
<meta property="og:url" content="http://example.com/2022/10/03/study/front/frame/react/render/index.html">
<meta property="og:site_name" content="埋书小楼">
<meta property="og:description" content="在探究render源码之前，首先对React v16.8需要简单认知一下； 在整个render过程中，其实分为两步骤：  render  commit 这里说的render函数只是开启上方两个环节的一个入口；   章节3.Fiber.md 中有提到： ​    react 的render阶段会将ReactElement对象，也就是虚拟节点对象；基于每一个ReactElement分割成一个一个的小任">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/render/render1.png">
<meta property="og:image" content="http://example.com/images/render/render2.png">
<meta property="og:image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/13/16f9c82b8d867dec~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp">
<meta property="og:image" content="http://example.com/images/react/ReactDOM.render.png">
<meta property="article:published_time" content="2022-10-03T02:30:18.000Z">
<meta property="article:modified_time" content="2022-10-03T08:17:37.363Z">
<meta property="article:author" content="书生">
<meta property="article:tag" content="前端：React">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/render/render1.png">


<link rel="canonical" href="http://example.com/2022/10/03/study/front/frame/react/render/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2022/10/03/study/front/frame/react/render/","path":"2022/10/03/study/front/frame/react/render/","title":"React.render的第一次研究"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>React.render的第一次研究 | 埋书小楼</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">埋书小楼</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">清光未泯，来岁无穷</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%BD%93"><span class="nav-number">1.</span> <span class="nav-text">函数体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#isValidContainer"><span class="nav-number">2.</span> <span class="nav-text">isValidContainer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#render%E9%98%B6%E6%AE%B5"><span class="nav-number">3.</span> <span class="nav-text">render阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96FiberRoot"><span class="nav-number">3.1.</span> <span class="nav-text">1 初始化FiberRoot</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-legacyRenderSubtreeIntoContainer"><span class="nav-number">3.1.1.</span> <span class="nav-text">1.1 legacyRenderSubtreeIntoContainer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-legacyCreateRootFromDOMContainer"><span class="nav-number">3.1.2.</span> <span class="nav-text">1.2 legacyCreateRootFromDOMContainer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-createLegacyRoot"><span class="nav-number">3.1.3.</span> <span class="nav-text">1.3 createLegacyRoot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-ReactDOMBlockingRoot"><span class="nav-number">3.1.4.</span> <span class="nav-text">1.4 ReactDOMBlockingRoot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-createRootImpl"><span class="nav-number">3.1.5.</span> <span class="nav-text">1.5 createRootImpl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-6-createContainer"><span class="nav-number">3.1.6.</span> <span class="nav-text">1.6 createContainer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-7-createFiberRoot"><span class="nav-number">3.1.7.</span> <span class="nav-text">1.7 createFiberRoot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.8.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-rootFiber%EF%BC%8CfiberRoot"><span class="nav-number">3.1.9.</span> <span class="nav-text">关于 rootFiber，fiberRoot</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#gt-1-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.9.1.</span> <span class="nav-text">&#x3D;&gt; 1. 数据结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#gt-2-%E5%8F%8C%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF"><span class="nav-number">3.1.9.2.</span> <span class="nav-text">&#x3D;&gt; 2.双缓存技术</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E7%89%87%E6%9D%A5%E8%87%AA%E7%BD%91%E4%B8%8A"><span class="nav-number">4.</span> <span class="nav-text">[图片来自网上]</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-8-initializeUpdateQueue"><span class="nav-number">4.0.1.</span> <span class="nav-text">1.8 initializeUpdateQueue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%B3%E6%AD%A4%EF%BC%8C%E5%9B%9E%E5%88%B0-1-1-%E5%90%8E%E7%BB%AD%E9%80%BB%E8%BE%91"><span class="nav-number">4.0.2.</span> <span class="nav-text">至此，回到 1.1 后续逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-9-updateContainer"><span class="nav-number">4.0.3.</span> <span class="nav-text">1.9 updateContainer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-10-enqueueUpdate"><span class="nav-number">4.0.4.</span> <span class="nav-text">1.10  enqueueUpdate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-11-scheduleWork"><span class="nav-number">4.0.5.</span> <span class="nav-text">1.11 scheduleWork</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E5%90%8E%EF%BC%8C%E8%BF%94%E5%9B%9E-rootFiber-child"><span class="nav-number">4.0.6.</span> <span class="nav-text">最后，返回 rootFiber.child</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-12-getPublicRootInstance"><span class="nav-number">4.0.7.</span> <span class="nav-text">1.12 getPublicRootInstance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-13-%E7%AE%80%E8%AE%B0"><span class="nav-number">4.0.8.</span> <span class="nav-text">1.13 简记</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9E%84%E5%BB%BAFiber%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.1.</span> <span class="nav-text">2  构建Fiber对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-performSyncWorkOnRoot"><span class="nav-number">4.1.1.</span> <span class="nav-text">2.1 performSyncWorkOnRoot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-prepareFreshStack"><span class="nav-number">4.1.2.</span> <span class="nav-text">2.2 prepareFreshStack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-createWorkInProgress"><span class="nav-number">4.1.3.</span> <span class="nav-text">2.3 createWorkInProgress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-workLoopSync"><span class="nav-number">4.1.4.</span> <span class="nav-text">2.4 workLoopSync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-performUnitOfWork"><span class="nav-number">4.1.5.</span> <span class="nav-text">2.5 performUnitOfWork</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-beginWork"><span class="nav-number">4.1.6.</span> <span class="nav-text">2.6 beginWork</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-updateHostRoot"><span class="nav-number">4.1.7.</span> <span class="nav-text">2.7 updateHostRoot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-reconcileChildren"><span class="nav-number">4.1.8.</span> <span class="nav-text">2.8 reconcileChildren</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-9-ChildReconciler"><span class="nav-number">4.1.9.</span> <span class="nav-text">2.9 ChildReconciler</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-9-1-placeSingleChild"><span class="nav-number">4.1.9.1.</span> <span class="nav-text">2.9.1 placeSingleChild</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-9-2-createFiberFromText"><span class="nav-number">4.1.9.2.</span> <span class="nav-text">2.9.2 createFiberFromText</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-9-3-reconcileSingleTextNode"><span class="nav-number">4.1.9.3.</span> <span class="nav-text">2.9.3 reconcileSingleTextNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-9-4-reconcileSingleElement"><span class="nav-number">4.1.9.4.</span> <span class="nav-text">2.9.4 reconcileSingleElement</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-9-5-reconcileChildrenArray"><span class="nav-number">4.1.9.5.</span> <span class="nav-text">2.9.5 reconcileChildrenArray</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-9-6-placeChild"><span class="nav-number">4.1.9.6.</span> <span class="nav-text">2.9.6 placeChild</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-9-7-mapRemainingChildren"><span class="nav-number">4.1.9.7.</span> <span class="nav-text">2.9.7 mapRemainingChildren</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-10-completeUnitOfWork"><span class="nav-number">4.1.10.</span> <span class="nav-text">2.10 completeUnitOfWork</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-10-1-completeWork"><span class="nav-number">4.1.10.1.</span> <span class="nav-text">2.10.1 completeWork</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-10-2-createInstance"><span class="nav-number">4.1.10.2.</span> <span class="nav-text">2.10.2 createInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-10-3-appendAllChildren"><span class="nav-number">4.1.10.3.</span> <span class="nav-text">2.10.3 appendAllChildren</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-11-%E7%AE%80%E8%AE%B0"><span class="nav-number">4.1.11.</span> <span class="nav-text">2.11 简记</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-12-%E8%A1%A5%E5%85%85"><span class="nav-number">4.1.12.</span> <span class="nav-text">2.12 补充</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-12-1-updateClassComponent"><span class="nav-number">4.1.13.</span> <span class="nav-text">2.12.1 updateClassComponent</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-12-1-1-updateClassComponent"><span class="nav-number">4.1.13.1.</span> <span class="nav-text">2.12.1.1 updateClassComponent</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-12-1-2-constructClassInstance"><span class="nav-number">4.1.13.2.</span> <span class="nav-text">2.12.1.2 constructClassInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-12-1-3-adoptClassInstance"><span class="nav-number">4.1.13.3.</span> <span class="nav-text">2.12.1.3 adoptClassInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-12-1-4-classComponentUpdater"><span class="nav-number">4.1.13.4.</span> <span class="nav-text">2.12.1.4 classComponentUpdater</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-12-1-5-mountClassInstance"><span class="nav-number">4.1.13.5.</span> <span class="nav-text">2.12.1.5 mountClassInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-12-1-6-finishClassComponent"><span class="nav-number">4.1.13.6.</span> <span class="nav-text">2.12.1.6 finishClassComponent</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-12-2-updateFunctionComponent"><span class="nav-number">4.1.14.</span> <span class="nav-text">2.12.2 updateFunctionComponent</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-12-2-renderWithHooks"><span class="nav-number">4.1.14.1.</span> <span class="nav-text">2.12.2  renderWithHooks</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-commit%E6%8F%90%E4%BA%A4%E6%B8%B2%E6%9F%93"><span class="nav-number">4.2.</span> <span class="nav-text">3 commit提交渲染</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-finishSyncRender"><span class="nav-number">4.2.1.</span> <span class="nav-text">3.1 finishSyncRender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-commitRoot"><span class="nav-number">4.2.2.</span> <span class="nav-text">3.2 commitRoot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-commitRootImpl"><span class="nav-number">4.2.3.</span> <span class="nav-text">3.3 commitRootImpl</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-1-do%E2%80%A6while%E7%9A%84flushPassiveEffects%EF%BC%88%E5%BF%BD%E7%95%A5%EF%BC%89"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">3.3.1 do…while的flushPassiveEffects（忽略）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-2-prepareForCommit%EF%BC%88%E5%BF%BD%E7%95%A5%EF%BC%89"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">3.3.2 prepareForCommit（忽略）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-3-commit-%E9%98%B6%E6%AE%B5%E4%B8%80"><span class="nav-number">4.2.3.3.</span> <span class="nav-text">3.3.3 commit 阶段一</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-3-1-commitBeforeMutationEffects"><span class="nav-number">4.2.3.3.1.</span> <span class="nav-text">3.3.3.1 commitBeforeMutationEffects</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-3-2-commitBeforeMutationEffectOnFiber"><span class="nav-number">4.2.3.3.2.</span> <span class="nav-text">3.3.3.2 commitBeforeMutationEffectOnFiber</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-4-commit-%E9%98%B6%E6%AE%B5%E4%BA%8C"><span class="nav-number">4.2.3.4.</span> <span class="nav-text">3.3.4 commit 阶段二</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-4-1-commitMutationEffects"><span class="nav-number">4.2.3.4.1.</span> <span class="nav-text">3.3.4.1 commitMutationEffects</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-4-2-commitPlacement"><span class="nav-number">4.2.3.4.2.</span> <span class="nav-text">3.3.4.2 commitPlacement</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-4-3-getHostParentFiber"><span class="nav-number">4.2.3.4.3.</span> <span class="nav-text">3.3.4.3 getHostParentFiber</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-4-4-insertOrAppendPlacementNodeIntoContainer"><span class="nav-number">4.2.3.4.4.</span> <span class="nav-text">3.3.4.4 insertOrAppendPlacementNodeIntoContainer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-4-5-insertInContainerBefore"><span class="nav-number">4.2.3.4.5.</span> <span class="nav-text">3.3.4.5 insertInContainerBefore</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-4-6-appendChildToContainer"><span class="nav-number">4.2.3.4.6.</span> <span class="nav-text">3.3.4.6 appendChildToContainer</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-5-commit-%E9%98%B6%E6%AE%B5%E4%B8%89"><span class="nav-number">4.2.3.5.</span> <span class="nav-text">3.3.5 commit 阶段三</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-5-1-commitLayoutEffects"><span class="nav-number">4.2.3.5.1.</span> <span class="nav-text">3.3.5.1 commitLayoutEffects</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-5-2-commitLayoutEffectOnFiber"><span class="nav-number">4.2.3.5.2.</span> <span class="nav-text">3.3.5.2 commitLayoutEffectOnFiber</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-5-3-commitUpdateQueue"><span class="nav-number">4.2.3.5.3.</span> <span class="nav-text">3.3.5.3 commitUpdateQueue</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-5-4-commitHookEffectListMount"><span class="nav-number">4.2.3.5.4.</span> <span class="nav-text">3.3.5.4 commitHookEffectListMount</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-3-5-5-commitAttachRef"><span class="nav-number">4.2.3.5.5.</span> <span class="nav-text">3.3.5.5 commitAttachRef</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#updateQueue"><span class="nav-number">5.</span> <span class="nav-text">updateQueue</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="nav-number">5.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#enqueueUpdate"><span class="nav-number">5.2.</span> <span class="nav-text">enqueueUpdate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#processUpdateQueue"><span class="nav-number">5.3.</span> <span class="nav-text">processUpdateQueue</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E7%AE%80%E5%9B%BE"><span class="nav-number">6.</span> <span class="nav-text">流程简图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="书生"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">书生</p>
  <div class="site-description" itemprop="description">博客</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/lbf911531" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lbf911531" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



          </div>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/yourname" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/03/study/front/frame/react/render/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="书生">
      <meta itemprop="description" content="博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="埋书小楼">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          React.render的第一次研究
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">

  
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-03 10:30:18 / 修改时间：16:17:37" itemprop="dateCreated datePublished" datetime="2022-10-03T10:30:18+08:00">2022-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>在探究render源码之前，首先对React v16.8需要简单认知一下；</p>
<p>在整个render过程中，其实分为两步骤：</p>
<ul>
<li><p>render</p>
</li>
<li><p>commit</p>
<p>这里说的render函数只是开启上方两个环节的一个入口；</p>
</li>
</ul>
<p>章节3.Fiber.md 中有提到：</p>
<p>​    react 的<strong>render阶段</strong>会将ReactElement对象，也就是虚拟节点对象；基于每一个ReactElement分割成一个一个的小任务，以循环的方式，在线程中随时打断与续接的过程中，将VDOM 转换成Fiber节点（这些小任务，暂时叫Fiber任务）；</p>
<p>   当顺着<strong>rootFiber</strong>直到最终点不再有VDOM需要被转换时，进入到下一个阶段——commit</p>
<p>​    而在<strong>commit阶段</strong>中，就是对上一阶段的的产物：需要被执行操作的fiber节点集合，进行相关dom操作。至此，整个由render函数开始的完整流程迎来结束。</p>
<p>​    简单来说：</p>
<ul>
<li><p>render 阶段负责创建 Fiber 数据结构并为 Fiber 节点打标记，标记当前 Fiber 节点要进行的 DOM 操作。</p>
</li>
<li><p>commit 阶段负责根据 Fiber 节点标记 ( effectTag ) 进行相应的 DOM 操作。</p>
</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">ReactDom<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>jsx<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>jsx代码在经过React.createElement之后，会将参数传递给ReactDOM.render方法；而render方法具体如下：</p>
<span id="more"></span> 
<h2 id="函数体"><a href="#函数体" class="headerlink" title="函数体"></a>函数体</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom/src/client/ReactDOMLegacy.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token operator">:</span> React$Element<span class="token operator">&lt;</span>any<span class="token operator">></span><span class="token punctuation">,</span>
  container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 检测 container 是否是符合要求的渲染容器</span>
  <span class="token comment">// 即检测 container 是否是真实的DOM对象</span>
  <span class="token comment">// 如果不符合要求就报错，后续逻辑将不再执行</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在开发环境下,这里不考虑</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
 
  <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
    <span class="token comment">// 父组件 初始渲染没有父组件 传递 null 占位</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    element<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    <span class="token comment">// 是否为服务器端渲染 false 不是服务器端渲染 true 是服务器端渲染</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>提炼上述代码，可知整个render方法所做的事情很少</p>
<p>入参：</p>
<ul>
<li>element ： ReactElement（也是jsx）</li>
<li>container： div#root</li>
<li>callback：render后的回调函数，可选</li>
</ul>
<p>函数体</p>
<ul>
<li>isValidContainer</li>
<li>legacyRenderSubtreeIntoContainer</li>
</ul>
<hr>
<ol>
<li> 接受三个参数</li>
<li>校验container的合法性</li>
<li>调用<code>legacyRenderSubtreeIntoContainer</code>方法</li>
</ol>
<h2 id="isValidContainer"><a href="#isValidContainer" class="headerlink" title="isValidContainer"></a>isValidContainer</h2><p><code>作用</code>：判断 node节点是否是一个可以用于挂载子节点的容器节点</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom/src/client/ReactDOMRoot.js</span>

<span class="token comment">// 返回布尔值，用于判断node是否是一个有效的容器节点（Dom节点）</span>
<span class="token comment">// 1. 元素节点</span>
<span class="token comment">// 2. document 节点(代表整个文档（DOM 树的根节点）)</span>
<span class="token comment">// 3. 文档碎片节点(代表轻量级的 Document 对象，能够容纳文档的某个部分)</span>
<span class="token comment">// 4. 注释节点且注释内容必须是 react-mount-point-unstable</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isValidContainer</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> mixed</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
    node <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">ELEMENT_NODE</span> <span class="token operator">||</span>
      node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_NODE</span> <span class="token operator">||</span>
      node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_FRAGMENT_NODE</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span> <span class="token operator">&amp;&amp;</span>
        node<span class="token punctuation">.</span>nodeValue <span class="token operator">===</span> <span class="token string">' react-mount-point-unstable '</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>@ 关于nodeType可以参考<a target="_blank" rel="noopener" href="https://www.w3school.com.cn/jsref/prop_node_nodetype.asp">这里</a></p>
<p>补充：</p>
<ol>
<li><p>文档碎片节点</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">document_createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>可用于优化Dom操作</code>；如：</p>
<p>​     多次使用节点方法(如：appendChild)绘制页面，每次都要刷新页面一次。效率也就大打折扣了；</p>
<p>​     而使用document_createDocumentFragment()创建一个文档碎片，把所有的新结点附加在其上，然后把文档碎片的内容一次性添加到document中，这也就只需要一次页面刷新就可以了。 </p>
<p>​     <strong><u>游离DOM树</u></strong></p>
<p>​     <u><strong>这是一种传统的减少Dom操作的方法之一（在原生中）</strong></u></p>
</li>
<li><p>注释节点</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span><span class="token string">"注释"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 注释节点的data属性与nodeValue属性相同 </p>
</li>
<li><p>nodeType 值为 number</p>
</li>
</ol>
<h2 id="render阶段"><a href="#render阶段" class="headerlink" title="render阶段"></a>render阶段</h2><p>通过分析render函数，发现：该函数的本质上调用了<code>legacyRenderSubtreeIntoContainer</code>方法，亦即，render阶段正式从此函数开始。</p>
<h3 id="1-初始化FiberRoot"><a href="#1-初始化FiberRoot" class="headerlink" title="1 初始化FiberRoot"></a>1 初始化FiberRoot</h3><h4 id="1-1-legacyRenderSubtreeIntoContainer"><a href="#1-1-legacyRenderSubtreeIntoContainer" class="headerlink" title="1.1 legacyRenderSubtreeIntoContainer"></a>1.1 legacyRenderSubtreeIntoContainer</h4><p>==&gt; 一切的入口 &lt;==</p>
<ul>
<li>调用 legacyCreateRootFromDOMContainer，创建fiberRoot</li>
<li>为callback绑定this，指向fiberRoot</li>
<li>执行 updateContainer，构建fiber对象，开启整个fiber树的渲染，乃至后续commit阶段</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMLegacy.js</span>
<span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
  parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 初始渲染时，这个为null</span>
  children<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span> <span class="token comment">// ReactElement, （jsx对象，亦即render函数的第一个入参）</span>
  container<span class="token operator">:</span> Container<span class="token punctuation">,</span> <span class="token comment">// DOM容器节点 div#root</span>
  forceHydrate<span class="token operator">:</span> boolean<span class="token punctuation">,</span> <span class="token comment">// 是否是服务端渲染 这里是false，不用考虑</span>
  callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span> <span class="token comment">// render的第三入参，一个回调函数，不用考虑</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">;</span>
  <span class="token keyword">let</span> fiberRoot<span class="token punctuation">;</span>
  <span class="token comment">// 不存在root表示，此次调用当前函数，是第一次，也就是根fiber节点创建之前</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
      container<span class="token punctuation">,</span>
      forceHydrate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
    <span class="token comment">// 处理callback的 this指向 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 这里将fiberRoot作为入参，返回了 render 方法第一个参数的真实 DOM 对象</span>
        <span class="token comment">// 关于 getPublicRootInstance 函数体，参考本章 1.10 节段</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// unbatchedUpdates 方法等同于内部 return (() => &#123;</span>
    <span class="token comment">//  updateContainer(children, fiberRoot, parentComponent, callback);</span>
    <span class="token comment">// &#125;)(); 亦即，执行入参函数 【return  fn()】</span>
    <span class="token comment">// updateContainer(children, fiberRoot, parentComponent, callback);</span>
    <span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// TODO: 这段代码，在这一节暂不考虑，等到更新时再回过来看</span>
   	<span class="token operator">...</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-2-legacyCreateRootFromDOMContainer"><a href="#1-2-legacyCreateRootFromDOMContainer" class="headerlink" title="1.2 legacyCreateRootFromDOMContainer"></a>1.2 legacyCreateRootFromDOMContainer</h4><p>该函数的作用如下：</p>
<ol>
<li><p>判断是否是服务端渲染，（尽管从上一层传递过来了一个布尔值表示非服务端，但这里还是有一个额外的条件协助判断）【 服务端渲染将  不再  执行后续逻辑 】</p>
</li>
<li><p>删除 容器节点（div#root）的所有子节点</p>
</li>
<li><p>调用 <strong>createLegacyRoot</strong> 函数</p>
</li>
</ol>
<p>！！ 本函数的返回值将被赋予给 <strong>container._reactRootContainer</strong>，这也是<strong>createLegacyRoot</strong>的返回值</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMLegacy.js</span>

<span class="token keyword">function</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
  container<span class="token punctuation">,</span> <span class="token comment">// div#root</span>
  forceHydrate<span class="token punctuation">,</span>  <span class="token comment">// 布尔值，是否服务端渲染</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootType <span class="token punctuation">&#123;</span>
 <span class="token comment">// 检测是否为服务器端渲染，</span>
 <span class="token comment">// 当forceHydrate为false时，尝试判断 container</span>
 <span class="token comment">//  是文档节点类型，则取 container.documentElement;</span>
 <span class="token comment">//  不是，则取 container.firstChild；不存在，则取null 赋值给rootElement变量</span>
 <span class="token comment">//  进而判断rootElement是否是元素节点且是否存在属性 ROOT_ATTRIBUTE_NAME = 'data-reactroot'，</span>
 <span class="token comment">//  true则shouldHydrate = true </span>
  <span class="token keyword">const</span> shouldHydrate <span class="token operator">=</span>
    forceHydrate <span class="token operator">||</span> <span class="token function">shouldHydrateDueToLegacyHeuristic</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果不是服务器端渲染</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldHydrate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> warned <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 配合开发环境下的条件语句所在代码块，类似一个lock的变量</span>
    <span class="token keyword">let</span> rootSibling<span class="token punctuation">;</span>
    <span class="token comment">// 开启循环 删除 container 容器中的所有子节点</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rootSibling <span class="token operator">=</span> container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 在开发环境中,这里执行一段只会执行一次的报错校验</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
      container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>rootSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">createLegacyRoot</span><span class="token punctuation">(</span>
    container<span class="token punctuation">,</span>
    shouldHydrate <span class="token operator">?</span> <span class="token punctuation">&#123;</span> hydrate<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由此，产生一个疑问：为什么要删除容器节点的所有子节点？</p>
<p>答：</p>
<p>  可能有时候需要在 container 中放置一些占位图或者 loading 图以提高首屏加载用户体验；等到真正渲染页面元素时，占位图就可以不再需要了。</p>
<p>  在将 ReactElement 渲染到 container 之前, 必然要先清空 container</p>
<p>  因为占位图和 ReactElement 不能同时显示</p>
<p>  此外，在加入占位代码时, 最好只有一个父级元素, 可以减少内部代码的循环次数以提高性能</p>
<h4 id="1-3-createLegacyRoot"><a href="#1-3-createLegacyRoot" class="headerlink" title="1.3 createLegacyRoot"></a>1.3 createLegacyRoot</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMRoot.js</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createLegacyRoot</span><span class="token punctuation">(</span>
  container<span class="token operator">:</span> Container<span class="token punctuation">,</span> <span class="token comment">// div#root</span>
  options<span class="token operator">?</span><span class="token operator">:</span> RootOptions<span class="token punctuation">,</span> <span class="token comment">// &#123; hydrate: true &#125; || undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// LegacyRoot === 0;以下代码等同 new ReactDOMBlockingRoot(container, 0);</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> LegacyRoot<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// return &#123; __internalRoot: FiberRoot &#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-4-ReactDOMBlockingRoot"><a href="#1-4-ReactDOMBlockingRoot" class="headerlink" title="1.4 ReactDOMBlockingRoot"></a>1.4 ReactDOMBlockingRoot</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMRoot.js</span>
<span class="token keyword">function</span> <span class="token function">ReactDOMBlockingRoot</span><span class="token punctuation">(</span>
  container<span class="token punctuation">,</span> <span class="token comment">// div#root</span>
  tag<span class="token punctuation">,</span> <span class="token comment">// 0</span>
  option<span class="token punctuation">,</span> <span class="token comment">// undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 此时的this 是&#123;&#125; （空对像）</span>
  <span class="token comment">// this指向始终调用调用当前函数的那个对象，如果是直接调用当前方法则是window</span>
  <span class="token comment">// 但，构造方法 或者 Class， this指向的则是实例对象，详情可以回头再翻一遍之前的笔记，new的模拟与this两篇章</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> <span class="token function">createRootImpl</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 构造方法没有指定return 默认等同 return this;</span>
  <span class="token comment">// ReactDOMBlockingRoot: &#123; __internalRoot: FiberRoot &#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此，再次记录，到此函数 <strong>container._reactRootContainer= { __internalRoot  }</strong></p>
<h4 id="1-5-createRootImpl"><a href="#1-5-createRootImpl" class="headerlink" title="1.5 createRootImpl"></a>1.5 createRootImpl</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMRoot.js</span>

<span class="token keyword">function</span> <span class="token function">createRootImpl</span><span class="token punctuation">(</span>
  container<span class="token punctuation">,</span> <span class="token comment">// div#root</span>
  tag<span class="token punctuation">,</span> <span class="token comment">// 0</span>
  options<span class="token punctuation">,</span> <span class="token comment">// undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 根据options 设定当前函数内有关服务端渲染的变量初值 hydrate hydrationCallbacks</span>
  <span class="token operator">...</span>
  <span class="token comment">// root = FiberRoot</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这行可以不关注 container.['__reactContainere$' + randomKey] = root.current; </span>
  <span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 服务器端渲染相关</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hydrate <span class="token operator">&amp;&amp;</span> tag <span class="token operator">!==</span> LegacyRoot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-6-createContainer"><a href="#1-6-createContainer" class="headerlink" title="1.6 createContainer"></a>1.6 createContainer</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberReconciler.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>
  containerInfo<span class="token punctuation">,</span> <span class="token comment">// div#root</span>
  tag<span class="token punctuation">,</span> <span class="token comment">// 0</span>
  hydrate<span class="token punctuation">,</span> <span class="token comment">// false</span>
  hydrationCallbacks<span class="token punctuation">,</span> <span class="token comment">// null</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-7-createFiberRoot"><a href="#1-7-createFiberRoot" class="headerlink" title="1.7 createFiberRoot"></a>1.7 createFiberRoot</h4><p><code>&lt;1.3，1.4，1.5，1.6节选&gt;</code>的本质就是当前函数，其核心就是当前函数也许是为了后续可扩展，拆成了上述4步。</p>
<ul>
<li><p>创建FiberRoot </p>
</li>
<li><p>创建rootFiber 【这是和FiberRoot不同的一个概念】</p>
</li>
<li><p>初始化 updateQueue对象给rootFiber </p>
</li>
<li><p>赋值（相互引用）：</p>
</li>
</ul>
<p>$$<br>FiberRoot.current = rootFiber;<br>$$</p>
<p>$$<br>rootFiber.stateNode = FiberRoot<br>$$</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>
  containerInfo<span class="token punctuation">,</span> <span class="token comment">// div#root</span>
  tag<span class="token punctuation">,</span> <span class="token comment">// 0 </span>
  hydrate<span class="token punctuation">,</span> <span class="token comment">// false </span>
  hydrationCallbacks<span class="token punctuation">,</span> <span class="token comment">// null</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 调用构造函数创建 fiberRoot实例对象</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// enableSuspenseCallback === false, 所以这里不会执行 if 代码片段</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSuspenseCallback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
  <span class="token comment">// 创建根节点的rootFiber </span>
  <span class="token comment">// 约等于 createFiber(HostRoot = 3, null, null, mode = 8);</span>
  <span class="token comment">// 约等于 new FiberNode(3, null, null, 8);</span>
  <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将 rootFiber 赋值给 FiberRoot.current 属性</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>
  <span class="token comment">// 将 FiberRoot 赋值给 rootFiber.stateNode 属性</span>
  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>
                               
  <span class="token comment">// 为 fiber 对象添加 updateQueue 属性, 初始化 updateQueue 对象</span>
  <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>uninitializedFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将FiberRoot返回 container._reactRootContainer= &#123; __internalRoot: root  &#125;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>=&gt; 构造函数返回结果如下：</p>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><h4 id="关于-rootFiber，fiberRoot"><a href="#关于-rootFiber，fiberRoot" class="headerlink" title="关于 rootFiber，fiberRoot"></a>关于 rootFiber，fiberRoot</h4><h5 id="gt-1-数据结构"><a href="#gt-1-数据结构" class="headerlink" title="=&gt; 1. 数据结构"></a>=&gt; 1. 数据结构</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">&#123;</span>                             
    callbackNode<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    callbackPriority<span class="token operator">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
    containerInfo<span class="token operator">:</span> div#root<span class="token punctuation">,</span>
    context<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    current<span class="token operator">:</span> rootFiber<span class="token punctuation">,</span>    <span class="token comment">/// ***** 这里指向了rootFiber对象（fiber）</span>
    finishedWork<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    firstPendingTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    firstSuspendedTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    hydrate<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    memoizedInteractions<span class="token operator">:</span> <span class="token function">Set</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>size<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    nextKnownPendingLevel<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    pendingChildren<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    pendingContext<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    pendingInteractionMap<span class="token operator">:</span> <span class="token function">Map</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>size<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    pingCache<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    lastExpiredTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 关于 fiber的各属性描述，回看 3.Fiber.md 一节</span>
<span class="token keyword">const</span> rootFiber <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  
    alternate<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    child<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    dependencies<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    effectTag<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    elementType<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    firstEffect<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    index<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    key<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    lastEffect<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    memoizedProps<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
    nextEffect<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    pendingProps<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    ref<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token keyword">return</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    sibling<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    stateNode<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> <span class="token comment">/// ***** 这里指向了root对象</span>
    tag<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>    
    type<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    updateQueue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="gt-2-双缓存技术"><a href="#gt-2-双缓存技术" class="headerlink" title="=&gt; 2.双缓存技术"></a>=&gt; 2.双缓存技术</h5><p>简言之： <strong>在内存中构建（canvas下一帧）并直接替换（canvas上一帧）</strong>的技术叫做<a href="https://link.juejin.cn/?target=https://baike.baidu.com/item/%E5%8F%8C%E7%BC%93%E5%86%B2">双缓存</a>。</p>
<p>类比到react中即是 ：</p>
<p> 在<code>React</code>中最多会同时存在两棵<code>Fiber树</code>。当前屏幕上<strong>显示内容</strong>对应的<code>Fiber树</code>称为<strong>current Fiber树</strong>，正在<strong>内存中构建</strong>的<code>Fiber树</code>称为<strong>workInProgress Fiber树</strong>。 </p>
<p><img src="/images/render/render1.png" alt="render1"></p>
<p><img src="/images/render/render2.png" alt="render2"></p>
<h2 id="图片来自网上"><a href="#图片来自网上" class="headerlink" title="[图片来自网上]"></a>[图片来自网上]</h2><p>fiberRoot是全局唯一的，rootFiber则是每一次更新或创建的产物；</p>
<p> 可以打个比方， fiberRoot是 <code>唯一礼物</code>，rootFiber则是 <code>礼物盒子</code>， 礼物<code>只有</code>一个，但盒子在必要的时候，可以<code>重新搭一个</code>，然后再次存放礼物。将礼物放到盒子里这个动作【fiberRoot.current = rootFiber】，就是将二者联系起来。（个人观点）</p>
<p>更加详细的说明可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904202104209415">双缓存技术</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/361787198/answer/942841740">知乎：reactRoot,rootFiber,fiberRoot对比</a> </p>
<p><a href="https://link.zhihu.com/?target=https://github.com/y805939188/simple-react/tree/master/procedure/%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB/fiber2">GitHub：关于rootFiber,fiberRoot</a></p>
<h4 id="1-8-initializeUpdateQueue"><a href="#1-8-initializeUpdateQueue" class="headerlink" title="1.8 initializeUpdateQueue"></a>1.8 initializeUpdateQueue</h4><p>创建updateQueue 对象，赋值给 <strong>rootFiber</strong>对象的 <code>updateQueue 属性</code></p>
<p>在此之前，rootFiber是不存在该属性的</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactUpdateQueue.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// rootFiber</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    baseState<span class="token operator">:</span> fiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>
    baseQueue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    shared<span class="token operator">:</span> <span class="token punctuation">&#123;</span>  pending<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    effects<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="至此，回到-1-1-后续逻辑"><a href="#至此，回到-1-1-后续逻辑" class="headerlink" title="至此，回到 1.1 后续逻辑"></a>至此，回到 1.1 后续逻辑</h4><p>重新简单梳理一下 1.2 节段到此：</p>
<ol>
<li><p>render 方法 中： </p>
<p>​        判断container是否合法，然后调用 legacyRenderSubtreeIntoContainer</p>
</li>
<li><p>legacyRenderSubtreeIntoContainer 方法中</p>
<p>​        根据 container._reactRootContainer 属性判断 当前阶段是 <del>创建 / 更新</del></p>
<p>​        此时，这里讨论的是 ———创建阶段———</p>
<p>​        因此，先调用了 legacyCreateRootFromDOMContainer 方法</p>
</li>
<li><p>legacyCreateRootFromDOMContainer 方法中</p>
<p>​        删除 div#root 中的 所有子节点</p>
<p>​        然后，开始了一层套一层的方法调用，</p>
<p>​        继而，分别创建了 fiberRoot 和 rootFiber对象，二者并互相引用</p>
<p>​        最终，将 fiberRoot  挂载到 container._reactRootContainer 上</p>
</li>
</ol>
<hr>
<p>【注】：如标题，从这里开始，要回到1.1 节段进行后续逻辑，同时也代表了 FiberRoot 初始化完成</p>
<h4 id="1-9-updateContainer"><a href="#1-9-updateContainer" class="headerlink" title="1.9 updateContainer"></a>1.9 updateContainer</h4><p>updateContainer是在 &lt;1.1节选 &gt;<code>legacyRenderSubtreeIntoContainer</code> 中调用的；</p>
<p>在它之前的关键函数是： <code>createFiberRoot</code>；</p>
<p>在它内部：</p>
<ol>
<li>计算过期时间</li>
<li>初始化 fiberRoot 的context属性</li>
<li>创建一个链式结构的待执行任务（update）</li>
<li>先后调用 enqueueUpdate，scheduleWork</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 计算任务的过期时间
 * 再根据任务过期时间创建 Update 任务
 * 通过任务的过期时间还可以计算出任务的优先级
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
  element<span class="token punctuation">,</span>    <span class="token comment">// element 要渲染的 ReactElement（jsx对象，亦即render函数的第一个入参）</span>
  container<span class="token punctuation">,</span>  <span class="token comment">// container Fiber Root 对象,也是 legacyCreateRootFromDomContainer的返回值</span>
  parentComponent<span class="token punctuation">,</span>  <span class="token comment">// parentComponent 父组件 初始渲染为 null</span>
  callback<span class="token punctuation">,</span>   <span class="token comment">// ReactElement 渲染完成执行的回调函数 ReactDOM.render的第三个参数</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ExpirationTime <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
  <span class="token comment">// container 获取 rootFiber</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token comment">// 获取当前距离 react 应用初始化的时间 1073741805(一个很大的数字，不一定是这个数)</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTimeForUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
  <span class="token comment">// 异步加载设置</span>
  <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// null</span>

  <span class="token comment">// 计算过期时间</span>
  <span class="token comment">// 为防止任务因为优先级的原因一直被打断而未能执行</span>
  <span class="token comment">// react 会设置一个过期时间, 当时间到了过期时间的时候</span>
  <span class="token comment">// 如果任务还未执行的话, react 将会强制执行该任务</span>
  <span class="token comment">// 初始化渲染时, 任务同步执行不涉及被打断的问题</span>
  <span class="token comment">// 过期时间被设置成了 1073741823, 这个数值表示当前任务为同步任务</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>
    currentTime<span class="token punctuation">,</span>
    current<span class="token punctuation">,</span>
    suspenseConfig<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 设置FiberRoot.context, 该方法首次执行时返回一个emptyContext, 是一个 &#123;&#125; 
   * (因为:!parentComponent) return &#123;&#125;; div#root没有父级ReactElement
   */</span> 
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始渲染时 Fiber Root 对象中的 context 属性值为 null</span>
  <span class="token comment">// 所以会进入到 if 中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 初始渲染时将 context 属性值设置为 &#123;&#125;</span>
    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>

  <span class="token comment">// 创建一个待执行任务 &#123;&#125;，内部执行了 update.next = update</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将要更新的内容挂载到更新对象中的 payload 中 方便后期获取</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span> element <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断 callback 是否存在</span>
  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 将 update 对象加入到当前 Fiber 的更新队列当中 (updateQueue)</span>
  <span class="token comment">// 待执行的任务都会被存储在 fiber.updateQueue.shared.pending 中</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调度和更新 current 对象</span>
  <span class="token function">scheduleWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回过期时间</span>
  <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-10-enqueueUpdate"><a href="#1-10-enqueueUpdate" class="headerlink" title="1.10  enqueueUpdate"></a>1.10  enqueueUpdate</h4><ol>
<li><p>初次渲染时，enqueueUpdate 内部执行逻辑   <em>近似</em></p>
<p> <strong>current.updateQueue.shared.pedding = update</strong></p>
<p> 也就是：经<code>&lt;1.8节选&gt; </code>initalizeUpdateQueue 初始化到rootFiber中的【updateQueue】对象 中 【shared.pedding】属性值，为 <code>&lt;1.9节选&gt; </code>定义的 【update】</p>
</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactUpdateQueue.js</span>
<span class="token comment">// 将任务(Update)存放于任务队列(updateQueue)中</span>
<span class="token comment">// 创建单向链表结构存放 update, next 用来串联 update</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> update</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 获取当前 Fiber 的 更新队列</span>
  <span class="token comment">/**
   * &#123; 
   *    baseState: null,
   *    baseQueue: null,
   *    effects: null,
   *    shared: &#123; pedding: null &#125;,
   * &#125;
   */</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token comment">// 如果更新队列不存在 就返回 null 【仅发生在 fiber 已经被卸载】</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token comment">// 获取待执行的 Update 任务，初始渲染时没有待执行的任务</span>
  <span class="token keyword">const</span> sharedQueue <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">;</span> <span class="token comment">// &#123; pedding: null &#125;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> sharedQueue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span> <span class="token comment">// null</span>
  <span class="token comment">// 如果没有待执行的 Update 任务</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 这是第一次更新, 创建一个循环列表.</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 将 Update 任务存储在 pending 属性中</span>
  sharedQueue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将上述代码用demo模拟：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> update1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token keyword">const</span> update2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token keyword">const</span> update3 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>

第一次： pending <span class="token operator">===</span> <span class="token keyword">null</span>
       
       执行 update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span> <span class="token comment">// &#123; next: update1, payload: &#123;1&#125; &#125;,</span>
       执行 pending <span class="token operator">=</span> update<span class="token punctuation">;</span> 
	   <span class="token comment">// =>  pending = update1; </span>
       <span class="token comment">//     update1.next = update1;</span>
       
第二次： pending <span class="token operator">!==</span> <span class="token keyword">null</span>
       
       执行 update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>  <span class="token comment">// &#123; next: update1, payload: &#123;2&#125; &#125;</span>
       执行 pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>  <span class="token comment">// update1.next = update2;</span>
       执行 pending <span class="token operator">=</span> update<span class="token punctuation">;</span> 
       <span class="token comment">// =>  pending = update2;</span>
	   <span class="token comment">//     update2.next = update1;</span>
       <span class="token comment">//     update1.next = update2;</span>
       <span class="token comment">//   2,1</span>

第三次： pending <span class="token operator">!==</span> <span class="token keyword">null</span>
      
       执行 update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>  <span class="token comment">// &#123; next: update1, payload: &#123;3&#125; &#125;</span>
       执行 pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span> <span class="token comment">// update2.next = update3;</span>
       执行 pending <span class="token operator">=</span> update<span class="token punctuation">;</span> 
       <span class="token comment">// =>  pending = update3;</span>
	   <span class="token comment">//     update3.next = update1;</span>
       <span class="token comment">//     update2.next = update3;</span>
       <span class="token comment">//   3,1,2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，这是一个环形链表</p>
<p>pending 永远指向最新进入该方法的 update，</p>
<p>一般的链表： 1，2，3，4，5，6  【1作为首，6作为尾，6再指向1】</p>
<p>但在这里： 6，1，2，3，4，5 【6作为首，5作为尾， 5再指向6】</p>
<h4 id="1-11-scheduleWork"><a href="#1-11-scheduleWork" class="headerlink" title="1.11 scheduleWork"></a>1.11 scheduleWork</h4><p>该函数作用如下：</p>
<ol>
<li>校验是否存在死循环【setState引发的】</li>
<li>重置 从rootFiber对象开始的所有子节点的过期时间 （初始时，只更新了rootFiber的）</li>
<li>调用 performSyncWorkOnRoot</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="token comment">// 判断任务是否为同步 调用同步任务入口</span>
<span class="token keyword">const</span> scheduleWork <span class="token operator">=</span> scheduleUpdateOnFiber<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>
  fiber<span class="token punctuation">,</span> <span class="token comment">// div#root 的fiber对象，也即rootFiber</span>
  expirationTime<span class="token punctuation">,</span> <span class="token comment">// 任务过期时间: 1073741823</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**
   * 该函数等同于：nestedUpdateCount > 50 ? throw error : null
   * 判断是否是无限循环的 update 如果是就报错
   * 在 componentWillUpdate 或者 componentDidUpdate 生命周期函数中重复调用
   * setState 方法时, 可能会发生这种情况, React 限制了嵌套更新的数量以防止无限循环
   * 通过(NESTED_UPDATE_LIMIT = 50) 全局变量获取
   */</span>
  <span class="token function">checkForNestedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 1.遍历fiber的所有子节点，并当子节点的expirationTime &lt; expirationTime 时， 
   *   设置子节点的 expirationTime = expirationTime
   * 2.返回 FiberRoot
   */</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">markUpdateTimeFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断是否有高优先级任务打断当前正在执行的任务</span>
  <span class="token comment">// 内部判断条件不成立 内部代码没有得到执行</span>
  <span class="token function">checkForInterruption</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 暂略</span>
  <span class="token function">recordScheduleUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取当前调度任务的优先级 数值类型 从90开始 数值越大 优先级越高</span>
  <span class="token comment">// 97 普通优先级任务</span>
  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断任务是否是同步任务 Sync的值为: 1073741823</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>expirationTime <span class="token operator">===</span> Sync<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">// (8 &amp; 8) !== 0 &amp;&amp; (8 &amp; (16 | 32)) === 0 </span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> LegacyUnbatchedContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> NoContext
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>
      <span class="token comment">// 同步任务入口点</span>
      <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">...</span> <span class="token comment">// 暂略</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
   	<span class="token operator">...</span> <span class="token comment">// 暂略</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 初始渲染不执行</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="最后，返回-rootFiber-child"><a href="#最后，返回-rootFiber-child" class="headerlink" title="最后，返回 rootFiber.child"></a>最后，返回 rootFiber.child</h4><h4 id="1-12-getPublicRootInstance"><a href="#1-12-getPublicRootInstance" class="headerlink" title="1.12 getPublicRootInstance"></a>1.12 getPublicRootInstance</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 获取 container 的第一个子元素的实例对象
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>
  container<span class="token punctuation">,</span>  <span class="token comment">// FiberRoot</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 获取 rootFiber</span>
  <span class="token keyword">const</span> containerFiber <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token comment">// 如果 rootFiber 没有子元素</span>
  <span class="token comment">// 指的就是 id="root" 的 div 没有子元素</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 匹配子元素的类型</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// component组件</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span> <span class="token comment">// case 5</span>
      <span class="token keyword">return</span> <span class="token function">getPublicInstance</span><span class="token punctuation">(</span>containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">// 返回子元素的真实 DOM 对象</span>
      <span class="token keyword">return</span> containerFiber<span class="token punctuation">.</span>child<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-13-简记"><a href="#1-13-简记" class="headerlink" title="1.13 简记"></a>1.13 简记</h4><ul>
<li><p>通过判断<strong>container（div#root）</strong>上是否存在 <strong>___reactRootContainer</strong> 得知是否初次渲染</p>
</li>
<li><p>createFiberRoot 方法中，正式进入主要的逻辑：创建<strong>rootFiber</strong>以及<strong>fiberRoot</strong></p>
<ul>
<li>前者是 根节点的fiber节点；后者是 全局唯一的对象，但它非ReactElement对象，非fiber对象</li>
<li>每一次的更新或渲染都可能会有一个新的 rootFiber，但不会有逻辑重新创建一个新的fiberRoot</li>
<li>fiberRoot.current = rootFiber;</li>
<li>rootFiber.stateNode = fiberRoot;</li>
<li>rootFiber.stateNode 和其他的fiber.stateNode 是有区别的；其他的fiber.stateNode会是dom实例或者组件实例；而根节点的stateNode却是firberRoot  (不用担心，fiberRoot上能找到div#root)</li>
</ul>
</li>
<li><p>由 1.9 updateContainer =&gt; 1.11 scheduleWork =&gt;  2.1 performSyncWorkOnRoot</p>
<p>【第一篇章，构建根节点；第二篇章，构建子级fiber节点】</p>
</li>
</ul>
<h3 id="2-构建Fiber对象"><a href="#2-构建Fiber对象" class="headerlink" title="2  构建Fiber对象"></a>2  构建Fiber对象</h3><p>以下逻辑，续 <code>&lt;节选 1.11&gt;</code>· scheduleWork</p>
<h4 id="2-1-performSyncWorkOnRoot"><a href="#2-1-performSyncWorkOnRoot" class="headerlink" title="2.1 performSyncWorkOnRoot"></a>2.1 performSyncWorkOnRoot</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberWorkLoop.js`</span>
<span class="token comment">/**
 * 进入 render 阶段, 构建 workInProgress Fiber 树
 * param &#123;*&#125; root : FiberRoot 对象
 */</span>
<span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 检查是否有过期的任务</span>
  <span class="token comment">// 初始化渲染没有过期的任务待执行；参照 1.7 createFiberRoot，自从创建fiberRoot对象后，该属性一直未被修改 </span>
  <span class="token keyword">const</span> lastExpiredTime <span class="token operator">=</span> root<span class="token punctuation">.</span>lastExpiredTime<span class="token punctuation">;</span> <span class="token comment">// NoWork 值为 0</span>
  <span class="token comment">// 如果有过期的任务 将过期时间设置为 lastExpiredTime； 否则将过期时间设置为 Sync；</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> lastExpiredTime <span class="token operator">!==</span> NoWork <span class="token operator">?</span> lastExpiredTime <span class="token operator">:</span> Sync<span class="token punctuation">;</span>
  <span class="token comment">// 这里涉及到 effects的处理，核心函数： flushPassiveEffectsImpl（ReactFiberWorkLoop.js）</span>
  <span class="token comment">// 记录：内部遍历先执行了 destory(),后又effect.destroy = create();也就是先卸载再创建</span>
  <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 说明 workInProgressRoot 不存在, 说明还没有构建 workInProgress Fiber 树</span>
  <span class="token comment">// workInProgressRoot 为全局变量 默认值为 null, 初始渲染时值为 null</span>
  <span class="token comment">// if(root !== null || 1073741823 !== 0)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> workInProgressRoot <span class="token operator">||</span> expirationTime <span class="token operator">!==</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 构建 workInProgressFiber 树及 rootFiber</span>
    <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 经过 上一步 prepareFreshStack，workInProgress已经存在值了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   	<span class="token operator">...</span>
    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 以同步的方式开始构建 Fiber 对象</span>
        <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>thrownValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> thrownValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token operator">...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 报错：无法提交不完整的 root, 此错误可能是由于React中的错误所致</span>
      <span class="token comment">// 代表 workLoopSync 内部遍历 出了问题</span>
      <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">stopFinishedWorkLoopTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将构建好的新 Fiber 对象存储在 finishedWork 属性中</span>
      <span class="token comment">// 提交阶段使用</span>
      root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      root<span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
      <span class="token comment">// 结束 render 阶段</span>
      <span class="token comment">// 进入 commit 阶段</span>
      <span class="token function">finishSyncRender</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-2-prepareFreshStack"><a href="#2-2-prepareFreshStack" class="headerlink" title="2.2 prepareFreshStack"></a>2.2 prepareFreshStack</h4><p>可暂时忽略本函数，内部核心是<code>&lt;2.3节选&gt;</code> createWorkInProgress</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="token comment">// root: FiberRoot对象，expirationTime === Snyc 一个具体的很大的数字</span>
<span class="token keyword">function</span> <span class="token function">prepareFreshStack</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// finishedWork 表示 render 阶段执行完成后构建的待提交的 Fiber 对象</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 初始化finishedWork属性</span>
  root<span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span> <span class="token comment">// 初始化 finishedExpirationTime 值为 0</span>

  <span class="token keyword">const</span> timeoutHandle <span class="token operator">=</span> root<span class="token punctuation">.</span>timeoutHandle<span class="token punctuation">;</span> <span class="token comment">// -1 </span>
  <span class="token operator">...</span> <span class="token comment">// 省略了一些初次render时不执行的代码段</span>
  
  <span class="token comment">// 建构 workInProgress Fiber 树的 fiberRoot 对象</span>
  workInProgressRoot <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token comment">// 构建 workInProgress Fiber 树中的 rootFiber</span>
  workInProgress <span class="token operator">=</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转到&lt;2.3节选></span>
    
  renderExpirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  workInProgressRootExitStatus <span class="token operator">=</span> RootIncomplete<span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-3-createWorkInProgress"><a href="#2-3-createWorkInProgress" class="headerlink" title="2.3 createWorkInProgress"></a>2.3 createWorkInProgress</h4><p>根据【FiberRoot】的【rootFiber】构建【 workInProgress】对象</p>
<p>其本质类似于 const workInProgress = { …rootFiber };</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiber.js`</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>
	current<span class="token punctuation">,</span>  <span class="token comment">// rootFiber</span>
    pendingProps <span class="token comment">// null</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 获取 current Fiber 对应的 workInProgress Fiber</span>
  <span class="token keyword">let</span> workInProgress <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建 fiber 对象， 这个方法与 &lt;1.7节选> 的createHostRootFiber核心一致 new FiberNode</span>
    workInProgress <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>
      current<span class="token punctuation">.</span>tag<span class="token punctuation">,</span>
      pendingProps<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 属性复用</span>
    workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">=</span> current<span class="token punctuation">.</span>elementType<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>type <span class="token operator">=</span> current<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

    <span class="token comment">// 使用 alternate 存储 current</span>
    workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span>
    <span class="token comment">// 使用 alternate 存储 workInProgress</span>
    current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>

  workInProgress<span class="token punctuation">.</span>childExpirationTime <span class="token operator">=</span> current<span class="token punctuation">.</span>childExpirationTime<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> current<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> current<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>sibling <span class="token operator">=</span> current<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>index <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>ref <span class="token operator">=</span> current<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>

  <span class="token keyword">const</span> currentDependencies <span class="token operator">=</span> current<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span> <span class="token comment">// null</span>
  <span class="token operator">...</span>  <span class="token comment">// (取dep部分变量设置到workInProgress.dependencies对象)</span>
 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// true</span>
    workInProgress<span class="token punctuation">.</span>selfBaseDuration <span class="token operator">=</span> current<span class="token punctuation">.</span>selfBaseDuration<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>treeBaseDuration <span class="token operator">=</span> current<span class="token punctuation">.</span>treeBaseDuration<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-4-workLoopSync"><a href="#2-4-workLoopSync" class="headerlink" title="2.4 workLoopSync"></a>2.4 workLoopSync</h4><p>本质： 循环语句</p>
<p><code>&lt;2.1节选&gt;</code> performSyncWorkOnRoot调用本函数，</p>
<p>在该函数之前，根据 FiberRoot.current 也就是 rootFiber 拷贝出了一个 workInProgress对象，挂到全局</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberWorkLoop.js</span>

<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**
   *  1.workInProgress 是一个 fiber 对象，是createWorkInProgress 创建的
   *  2.它的值不为 null 意味着该 fiber 对象上仍然有更新要执行；
   *    为null时，表示从根节点已经遍历到了最后一个子节点；
   *  3.while 方法支撑 render 阶段 所有 fiber 节点的构建
   */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此处方法可以结合 &lt;文件 3.Fiber.md&gt;</p>
<h4 id="2-5-performUnitOfWork"><a href="#2-5-performUnitOfWork" class="headerlink" title="2.5 performUnitOfWork"></a>2.5 performUnitOfWork</h4><p>概念重提：</p>
<p>React Fiber的渲染过程中，其实是存在两棵 fiber树：</p>
<ul>
<li>一颗是currentFiber树，也就是在页面中渲染的</li>
</ul>
<ul>
<li>另一颗是当前正在构建的 workInProgress 树（姑且这样称呼）</li>
</ul>
<p>当 workInProgress树构建完成后，会替换 currentFiber树成为新的currentFiber树</p>
<p>尽管初始化页面时，不存在currentFiber树；</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberWorkLoop.js</span>

<span class="token comment">// param &#123;*&#125; unitOfWork: workInProgress</span>
<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">unitOfWork</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">/**
   * 在 createWorkInProgress 方法中，创建的workInPorgress对象定义了alternate的值，
   * 指向 currentFiber树中的rootFiber
   */</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span> 
  <span class="token keyword">let</span> next<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>unitOfWork<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ProfileMode<span class="token punctuation">)</span> <span class="token operator">!==</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 初始化时没有走这一段</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 从父级到子级，构建fiber，返回当前父级的第一个子级 </span>
    next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  unitOfWork<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token comment">// 为null表示走到了底， 也是 workLoopSync 可以结束的时候</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 此时的unitOfWork 不再是 rootFiber，而是子级，也就是说</span>
    <span class="token comment">// 这里的方法是从子级到父级的一个过程  </span>
    next <span class="token operator">=</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// next 不为null，则以next为父级，遍历其子级</span>
  ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-6-beginWork"><a href="#2-6-beginWork" class="headerlink" title="2.6 beginWork"></a>2.6 beginWork</h4><p>整个函数分为两个部分</p>
<p>=》 判断是否存在旧fiber节点，</p>
<p>=》是，则判断 updateExpirationTime &lt; renderExpirationTime </p>
<p>​           （可以直接复用前一次更新的子Fiber, 不需要新建子Fiber；初始渲染为false）</p>
<p>=》 否，则根据 fiber.type 判断创建具体的fiber节点对应的stateNode</p>
<p>简单来说，整体就是一个大的 if…else 代码块；由这个代码块的判断再具体调用不同的函数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberBeginWork.js</span>

<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  current<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  renderExpirationTime<span class="token punctuation">,</span> <span class="token comment">// 1073741823</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1073741823</span>
  <span class="token keyword">const</span> updateExpirationTime <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>expirationTime<span class="token punctuation">;</span>
 
  <span class="token comment">// 初始渲染时 只有 rootFiber 节点存在 current</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// true</span>
    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>   <span class="token comment">// 获取旧的 props 对象</span>
    <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>    <span class="token comment">// 获取新的 props 对象</span>
    <span class="token comment">// 初始阶段，以下代码块没有执行，且以下 关乎 diff 环节</span>
    <span class="token operator">...</span> 
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> didReceiveUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  workInProgress<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span> <span class="token comment">// 0 清空过期时间</span>
  <span class="token comment">// 根据当前 Fiber 的类型决定如何构建起子级 Fiber 对象</span>
  <span class="token comment">// 文件位置: shared/ReactWorkTags.js</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 函数组件在第一次被渲染时使用</span>
    <span class="token keyword">case</span> IndeterminateComponent<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// case 2</span>
      <span class="token keyword">return</span> <span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>  <span class="token comment">// 旧 Fiber</span>
        workInProgress<span class="token punctuation">,</span>   <span class="token comment">// 新 Fiber</span>
        workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token comment">// 新 Fiber 的 type 值 初始渲染时是App组件函数</span>
        renderExpirationTime<span class="token punctuation">,</span> <span class="token comment">// 同步 整数最大值 1073741823</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// case 0</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// case 1</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 在这里，初始化时内部会调用 mountClassInstance 方法，并执行componentWillMount  </span>
      <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">case</span> HostRoot<span class="token operator">:</span> <span class="token comment">// case 3</span>
      <span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span> <span class="token comment">// case 5</span>
      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostText<span class="token operator">:</span> <span class="token comment">// case 6</span>
      <span class="token keyword">return</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 校验，报错</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-7-updateHostRoot"><a href="#2-7-updateHostRoot" class="headerlink" title="2.7 updateHostRoot"></a>2.7 updateHostRoot</h4><p>这里以 updateHostRoot 为例一：</p>
<ol>
<li>memoizedState 的值是： {  element:   ReactElement  } 【子节点 】</li>
<li>pendingProps 存放即将要更新的props属性</li>
<li>updateQueue 是一条链，链的每一环都与 子节点相关</li>
<li>调用 reconcileChildren 构建子fiber</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberReconciler.js</span>

<span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">pushHostRootContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可暂时忽略，没有对workInProgress添加其他属性</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>  <span class="token comment">// 获取更新队列</span>
  <span class="token keyword">const</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>   <span class="token comment">// 获取新的 props 对象，null</span>
  <span class="token keyword">const</span> prevState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>  <span class="token comment">// 获取上一次渲染使用的 state， null</span>
  <span class="token comment">// 获取上一次渲染使用的 children，null</span>
  <span class="token keyword">const</span> prevChildren <span class="token operator">=</span> prevState <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> prevState<span class="token punctuation">.</span>element <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
  <span class="token comment">// 浅拷贝：if(workInProgress.updateQueue === current.updateQueue) workInProgress.updateQueue = &#123; ...current.updateQueue &#125;; </span>
  <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token comment">// 获取 updateQueue.payload 并赋值到 workInProgress.memoizedState</span>
  <span class="token comment">// 要更新的内容就是 element 就是 rootFiber 的子元素</span>
  <span class="token comment">/**
   * 1. &lt;节选1.10> enqueueUpdate 创建了一个update，同时让update.next = update;形成了一条链
        到了这里，内部有一个do...while循环，其跳出条件就是 update.next === null 或 
        update.next=== update；个人认为很巧妙的解决了 死循环
   * 2. 内部取 workfInProgress.updateQueue.shared.pending.paylpad 放到了 
        memoizedState 上；同时往 updateQueue.effectes数组 添加了 pending，
        此外，设定 updateQueue.baseState = payload 
   * 3. payload 对象内存放了element属性，也就是 ReactElement类型的 子节点
   *
   * 4. 简言之，取更新队列中的 pending属性，更新该fiber节点的baseState，以及更新队列的effects数组
   */</span>
  <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取 element 所在对象</span>
  <span class="token keyword">const</span> nextState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span> <span class="token comment">// payload</span>
  <span class="token comment">// 从对象中获取 element</span>
  <span class="token keyword">const</span> nextChildren <span class="token operator">=</span> nextState<span class="token punctuation">.</span>element<span class="token punctuation">;</span> <span class="token comment">// payload.element</span>
    
  <span class="token comment">// 在计算 state 后如果前后两个 Children 相同的情况</span>
  <span class="token comment">// prevChildren === null, nextState === App</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextChildren <span class="token operator">===</span> prevChildren<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">resetHydrationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>   <span class="token comment">// FiberRoot 对象</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>hydrate <span class="token operator">&amp;&amp;</span> <span class="token function">enterHydrationState</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 服务器端渲染</span>
    <span class="token operator">...</span>  
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 客户端渲染走 else</span>
    <span class="token comment">// 构建子节点 fiber 对象</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resetHydrationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 返回子节点 fiber 对象</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-8-reconcileChildren"><a href="#2-8-reconcileChildren" class="headerlink" title="2.8 reconcileChildren"></a>2.8 reconcileChildren</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberBeginWork.js</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
  current<span class="token punctuation">,</span> <span class="token comment">// current fiber树中的fiber节点， 也就是目前正在视图内的</span>
  workInProgress<span class="token punctuation">,</span> <span class="token comment">// 即将渲染的新 fiber节点，待流程结束后，会替换掉current，然后再置空</span>
  nextChildren<span class="token punctuation">,</span> <span class="token comment">// 子级 ReactElement，也可以理解为 子级 VDOM</span>
  renderExpirationTime<span class="token punctuation">,</span> <span class="token comment">// Sync 表同步的数值</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**
   * 如果初始渲染时,current = null 
   * 非初始渲染时， 根据current，workInProgress进行新旧 Fiber 对比
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 初始渲染</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 更新</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      current<span class="token punctuation">.</span>child<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-9-ChildReconciler"><a href="#2-9-ChildReconciler" class="headerlink" title="2.9 ChildReconciler"></a>2.9 ChildReconciler</h4><p>无论是更新还是创建 fiber节点，都是调用 ChildReconciler方法的return值</p>
<ul>
<li>mountChildFibers = ChildReconciler(false);</li>
<li>reconcileChildFibers = ChildReconciler(true);</li>
</ul>
<ol>
<li>判断 workInProgress 的子节点是否是 Fragment，是则取fragment的子节点</li>
<li></li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactChildFiber.js</span>

<span class="token keyword">function</span> <span class="token function">ChildReconciler</span><span class="token punctuation">(</span><span class="token parameter">shouldTrackSideEffects</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 省略了很多暂时用不到的方法，以及 reconcileChildFibers内部调用的方法</span>
    <span class="token operator">...</span>     
  <span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span> 
    returnFiber<span class="token punctuation">,</span>  <span class="token comment">// 父 Fiber 对象  [workInProgress]</span>
    currentFirstChild<span class="token punctuation">,</span> <span class="token comment">// 旧的第一个子 Fiber 初始渲染 [null]</span>
    newChild<span class="token punctuation">,</span>   <span class="token comment">// 新的子 vdom 对象 [nextChildren]</span>
    expirationTime<span class="token punctuation">,</span> <span class="token comment">// Sync 同步   [renderExpirationTime]</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 判断 newChild 是否为占位组件 比如 &lt;>&lt;/>，&lt;React.Fragment /></span>
    <span class="token keyword">const</span> isUnkeyedTopLevelFragment <span class="token operator">=</span>
      <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
      newChild <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
      newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REACT_FRAGMENT_TYPE</span> <span class="token operator">&amp;&amp;</span>
      newChild<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 newChild 为占位符, 使用 占位符组件的子元素作为 newChild</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnkeyedTopLevelFragment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      newChild <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// tip: newChild 可能是“对象” 也可能是“数组”；    </span>
    <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 匹配子元素的类型</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 子元素为 ReactElement</span>
        <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
          <span class="token comment">// 为 Fiber 对象设置 effectTag 属性</span>
          <span class="token comment">// 返回创建好的子 Fiber</span>
          <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span>
            <span class="token comment">// 处理单个 React Element 的情况</span>
            <span class="token comment">// 内部会调用其他方法创建对应的 Fiber 对象</span>
            <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
              returnFiber<span class="token punctuation">,</span>
              currentFirstChild<span class="token punctuation">,</span>
              newChild<span class="token punctuation">,</span>
              expirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 暂不考虑</span>
        <span class="token comment">// portal: ReactDOM.createPortal 一种将子节点渲染到存在于父组件以外的 DOM 节点的方案</span>
        <span class="token comment">// https://zh-hans.reactjs.org/docs/portals.html#gatsby-focus-wrapper</span>
        <span class="token keyword">case</span> <span class="token constant">REACT_PORTAL_TYPE</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span>
            <span class="token function">reconcileSinglePortal</span><span class="token punctuation">(</span>
              returnFiber<span class="token punctuation">,</span>
              currentFirstChild<span class="token punctuation">,</span>
              newChild<span class="token punctuation">,</span>
              expirationTime<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 处理 children 为文本和数值的情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span>
        <span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span>
          returnFiber<span class="token punctuation">,</span>
          currentFirstChild<span class="token punctuation">,</span>
          <span class="token string">''</span> <span class="token operator">+</span> newChild<span class="token punctuation">,</span>  <span class="token comment">// 如果 newChild 是数值, 转换为字符串</span>
          expirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 返回创建好的子 Fiber</span>
      <span class="token keyword">return</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>
        returnFiber<span class="token punctuation">,</span>
        currentFirstChild<span class="token punctuation">,</span>
        newChild<span class="token punctuation">,</span>
        expirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getIteratorFn</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token function">reconcileChildrenIterator</span><span class="token punctuation">(</span>
        returnFiber<span class="token punctuation">,</span>
        currentFirstChild<span class="token punctuation">,</span>
        newChild<span class="token punctuation">,</span>
        expirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> reconcileChildFibers<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-9-1-placeSingleChild"><a href="#2-9-1-placeSingleChild" class="headerlink" title="2.9.1 placeSingleChild"></a>2.9.1 placeSingleChild</h5><ul>
<li>其他子级节点具有默认值为 0 防止在 commit 阶段反复操作真实DOM</li>
<li>初始渲染，且是根组件（即React.render方法的第一个参数对应的fiber节点）将进入这段if语句</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects <span class="token operator">&amp;&amp;</span> newFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    newFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> Placement<span class="token punctuation">;</span> <span class="token comment">// 2 Placement 表示新创建的节点</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> newFiber<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-9-2-createFiberFromText"><a href="#2-9-2-createFiberFromText" class="headerlink" title="2.9.2 createFiberFromText"></a>2.9.2 createFiberFromText</h5><p>创建文本节点</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberFromText</span><span class="token punctuation">(</span>
  <span class="token parameter">content<span class="token punctuation">,</span>
  mode<span class="token punctuation">,</span>
  expirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// HostText: 6</span>
  <span class="token comment">// tag, peddingProps, key, mode  </span>
  <span class="token comment">// 本质上，仍是调用 new FiberNode 构造方法</span>
  <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>HostText<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token keyword">return</span> fiber<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>createFiberFromFragment 与当前函数类似</p>
<h5 id="2-9-3-reconcileSingleTextNode"><a href="#2-9-3-reconcileSingleTextNode" class="headerlink" title="2.9.3 reconcileSingleTextNode"></a>2.9.3 reconcileSingleTextNode</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 处理子元素是文本或者数值的情况</span>
  <span class="token keyword">function</span> <span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span>
    returnFiber<span class="token punctuation">,</span> <span class="token comment">// workInProgress 也是当前将要处理的节点的父级fiber</span>
    currentFirstChild<span class="token punctuation">,</span> <span class="token comment">// 当前将要处理的节点，文本或数值</span>
    textContent<span class="token punctuation">,</span> <span class="token comment">// 文本节点的值，string类型（数字会被转字符串）</span>
    expirationTime<span class="token punctuation">,</span> <span class="token comment">// Sync</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 初始渲染不执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFirstChild <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> currentFirstChild<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> existing <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>currentFirstChild<span class="token punctuation">,</span> textContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      existing<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
      <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 现有的第一个子节点不是文本节点，因此我们需要创建一个并删除现有的.</span>
    <span class="token comment">// 初始渲染不执行</span>
    <span class="token comment">// 注意，这里不是真的删除，而是赋予effectTag = Delete </span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据文本创建 Fiber 对象</span>
    <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromText</span><span class="token punctuation">(</span>
      textContent<span class="token punctuation">,</span>
      returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
      expirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置父 Fiber 对象</span>
    created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
    <span class="token comment">// 返回创建好的 Fiber 对象</span>
    <span class="token keyword">return</span> created<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-9-4-reconcileSingleElement"><a href="#2-9-4-reconcileSingleElement" class="headerlink" title="2.9.4 reconcileSingleElement"></a>2.9.4 reconcileSingleElement</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 处理子元素是单个对象的情况</span>
 <span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
   returnFiber<span class="token punctuation">,</span> <span class="token comment">// 父 Fiber 对象</span>
   currentFirstChild<span class="token punctuation">,</span>  <span class="token comment">// 备份子 fiber，初始是null，当commit了一次以后，这个就会有值了</span>
   element<span class="token punctuation">,</span>  <span class="token comment">// 子 vdom 对象</span>
   expirationTime<span class="token punctuation">,</span>
 <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">const</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
   <span class="token keyword">let</span> child <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
   <span class="token comment">// 初始渲染 currentFirstChild 为 null，所以不走 while </span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span> 
   <span class="token comment">// 查看子 vdom 对象是否表示 fragment</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REACT_FRAGMENT_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromFragment</span><span class="token punctuation">(</span>
       element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
       returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
       expirationTime<span class="token punctuation">,</span>
       element<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
     <span class="token punctuation">)</span><span class="token punctuation">;</span>
     created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
     <span class="token keyword">return</span> created<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
     <span class="token comment">// 根据 React Element 创建 Fiber 对象</span>
     <span class="token comment">// 返回创建好的 Fiber 对象</span>
     <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>
       element<span class="token punctuation">,</span>
       <span class="token comment">// 用来表示当前组件下的所有子组件要用处于何种渲染模式</span>
       <span class="token comment">// 文件位置: ./ReactTypeOfMode.js</span>
       <span class="token comment">// 0    同步渲染模式</span>
       <span class="token comment">// 100  异步渲染模式</span>
       returnFiber<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
       expirationTime<span class="token punctuation">,</span>
     <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// 添加 ref 属性 具体如下文</span>
     created<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token function">coerceRef</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// 添加父级 Fiber 对象</span>
     created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
     <span class="token comment">// 返回创建好的子 Fiber</span>
     <span class="token keyword">return</span> created<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于方法 <strong>coerceRef</strong> 有一些补充，从源码来看，它判断了：</p>
<p>​    element.ref 存在且  element.ref 非方法，非对象时才执行内部具体逻辑</p>
<p>​    否则，直接返回 element.ref </p>
<p>​    用实例来说：</p>
<p>​         假如有 &lt;App  ref={ref =&gt; {this.inst = ref} } /&gt;</p>
<pre><code>     那么，此时代码运行到这：  created.ref  =  ref =&gt; &#123; this.inst = ref &#125;
</code></pre>
<p>   —- —- 也就是说，此时，只是创建了 ref属性而已，至于真正的 ref实例，暂时还没有。</p>
<h5 id="2-9-5-reconcileChildrenArray"><a href="#2-9-5-reconcileChildrenArray" class="headerlink" title="2.9.5 reconcileChildrenArray"></a>2.9.5 reconcileChildrenArray</h5><ol>
<li>遍历children数组，创建 children 中成员对应的fiber节点，并通过silbing属性形成链</li>
<li>返回 children 中的第一个fiber （返回它就可以了，通过它可以取到所有的兄弟fiber节点）</li>
</ol>
<p>关于diff</p>
<ol>
<li><p>循环结束场景： </p>
<pre><code>  1.1. 新旧长度一致，新旧都遍历完成
  1.2. 新的比旧的短，新的完成遍历
  1.3. 新的比旧的长，旧的遍历完成 oldFiber === null,跳出循环
</code></pre>
</li>
<li><p>updateSlot:</p>
<p>​    取新旧fiber的key对比，</p>
<p>​    2.1. 如果相同则执行 <code>updateTextNode,updateFragment,updateElement...</code></p>
<p>​            这个方法内部 会调用 useFiber ；参照旧fiber克隆一个新的，并将新节点的props挂上去，给值    </p>
<p>​           pendingProps</p>
<p>   —  调用栈：<br>$$<br>【updateSlot =&gt; useFiber =&gt; createWorkInProgress】<br>$$<br>​    2.2. 如果不同，则返回null</p>
</li>
<li><p> updateFromMap</p>
</li>
</ol>
<p>   类似updateSlot , 但不同于 updateSlot 的是， 在这个方法中，是通过新fiber的key去map找看是否有能复用的，没有key的则以index去找；而updateSlot则是遍历新children数组中，对比index相同的新旧fiber的key</p>
<ol start="4">
<li> 摘抄 “</li>
</ol>
<p>​            reconcileChildrenArray 方法：</p>
<p>​           首先逐个对比(相同位置对比)两个数组，如果相等则继续，如果有任何一个不等，那么跳出循环。如果     </p>
<p>​     老的数组全部被复用，那么补齐新数组，如果新数组已经完成，那么删除老数组中多余的部分。如果新数</p>
<p>​     组没有完全生成，老数组也没有完全复用，那么创建一个 map，用于存放未被复用的老数组，然后遍历剩</p>
<p>​      余的新数组，检查是否能从老数组中得到可复用的部分，有则复用，没有则新建。最后老的没有匹配到的</p>
<p>​      都要删除。 “</p>
<p>​      ——————-来自（<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/114767940%EF%BC%89">https://zhuanlan.zhihu.com/p/114767940）</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 处理子元素是数组的情况</span>
<span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>
  returnFiber<span class="token punctuation">,</span>     <span class="token comment">// 父级 Fiber</span>
  currentFirstChild<span class="token punctuation">,</span> <span class="token comment">// null</span>
  newChildren<span class="token punctuation">,</span>  <span class="token comment">// 子级 vdom 数组</span>
  expirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**
   * 存储第一个子节点 Fiber 对象
   * 方法返回的也是第一个子节点 Fiber 对象
   * 因为其他子节点 Fiber 对象都存储在上一个子 Fiber 节点对象的 sibling 属性中
   */</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">// 上一次创建的 Fiber 对象</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>   <span class="token comment">// 初始渲染没有旧的子级 所以为 null</span>

  <span class="token keyword">let</span> lastPlacedIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token comment">// 初始渲染 oldFiber 为 null 循环不执行</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 如果oldFiber.index 大于了newIdx，表示是移动，旧的 fiber 会等待新的 fiber，一直等到位置相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>index <span class="token operator">></span> newIdx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 4,2,3,1 // 1,2,3,4 这种会直接重新构建</span>
      nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">;</span>
      oldFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 这里，有一种场景要注意一下：</span>
      <span class="token comment">// 倘若 newChildren.length > oldChildren.length 即原[a,b] ,新[a.b,c]</span>
      <span class="token comment">// 则在某一时刻， nextOldFiber 一定会等于null, 这恰好能符合下面 if (oldFiber === null)</span>
      <span class="token comment">// 对新成员创建，此时也会跳出循环</span>
      nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 如果新旧fiber的key不同则会是null，如果相同，则基于旧fiber，赋值新的变更到pendingProps属性上</span>
    <span class="token comment">// 这里面根据key 判断是否可以复用节点</span>
    <span class="token comment">// 此时，如果NewFiber有值，那么它的index 默认为0；  </span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>
      returnFiber<span class="token punctuation">,</span>
      oldFiber<span class="token punctuation">,</span>
      newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
      expirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// key 不相同，表示不能复用，跳出循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span> 
        <span class="token comment">// 这里个人认为会避免走下面初始创建逻辑，下面是用了oldFiber判断是否为null</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 跳出循环</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ----- 到这里，表示 旧节点可以复用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> newFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 更新 lastPlacedIndex  判定哪些节点需要被标记 （插入effectTag）</span>
    <span class="token comment">// placeChild 函数 通过alternate属性取了旧树节点，，如果没有，则newFiber是创建</span>
    <span class="token comment">// 如果有则判断二者的index，如果旧index小于 lastPlacedIndex，则打上移动的effectTag</span>
    <span class="token comment">// 这个方法里，会执行 newFiber.index = newIdx  </span>
    lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// TODO: Move out of the loop. This only happens for the first run.</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 初始渲染不执行  删除在旧数组中不在新数组中的数据（这是当遍历完新数组后发现旧的还不能遍历完时）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// oldFiber 为空 说明是初始渲染</span>
  <span class="token comment">// 又或者是上面的遍历被打断了，此时可能存在新数组中较旧数组有 新成员，需要遍历剩下的并创建    </span>
  <span class="token comment">// 如： [1,2]   [1,2,3]  1,2 可以复用，</span>
  <span class="token comment">// 但:  遍历到3时， 旧数组的nextOldFiber不存在，给到oldFiber也就不存在   </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 遍历子 vdom 对象</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 创建子 vdom 对应的 fiber 对象</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>
        returnFiber<span class="token punctuation">,</span>
        newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">,</span>
        expirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果 newFiber 为 null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 进入下次循环</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 1. 初始渲染时只为 newFiber 添加了 index 属性,其他逻辑因为判断全部拦截了</span>
      <span class="token comment">// 2. lastPlacedIndex 原封不动的返回</span>
      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 生成链结构 lastChildFiber.sibling = newChildFiber;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 存储第一个子 Fiber 发生在第一次循环时</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 为节点设置下一个兄弟 Fiber</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 在循环的过程中更新上一个创建的Fiber 对象</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 返回创建好的子 Fiber</span>
    <span class="token comment">// 其他 Fiber 都作为 sibling 存在</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/**
   * 要想走到这里
   *  1. current !== null;  
   *     可能执行了 newFiber === null; oldFiber=== null
   *      如旧数组： 1,2,3  新数组 3,2,1
   *      3的原index 是2,新index 是0，在上方判断 oldFiber.index > newIdx 成立
   *      同时 updateSlot,判断3的key是3，而oldFiber的key 是 1， 1!== 3 成立 newFiber == null
   *  ---------------  
   *  即 位置移动
   *  ---------------
   * 2.  newFiber === null
   *      如旧数组：1,2,3  新数组 1,3
   *      - 遍历到1，保留 可以复用
   *      - 遍历到3，oldFiber是2,key 为2, newChildren[newIdx] 是3,key 是3, updateSlot表示不      *        能复用
   *  ---------------  
   *  即 成员删除
   *  ---------------
   * 3.
   *     如旧数组：1,2,4   新数组 1,3,4
   *     - 遍历到1， 保留复用
   *     - 遍历到3， oldFiber.key === 2, newChildren[newIdx].key === 3, updateSlot表示不能
   *       复用
   *  ---------------  
   *  即 成员变更
   *  ---------------
   *  之后会再开启一次循环，从上方被强制执行了break后的地方接续，此时剩余的旧fiber被维护到map集合中
   *  该次循环中，则通过新fiber的key去 map集合中查找看是否有能复用的成员，否则新增
   */</span>
      
  <span class="token comment">// 这里返回了一个map结构， 其目的是遍历了旧fiber及其兄弟节点，按照有key则取key，无key则index</span>
  <span class="token comment">// 作为map的key，存储 【 existingChildren.set(existingChild.key, existingChild)】</span>
  <span class="token keyword">var</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
  <span class="token operator">...</span>
  <span class="token comment">// 初始渲染不执行 初始会走到上面的 oldFiber === null判断，然后直接return 了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    existingChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>值得一提的是，可以看到这里的 <code>&lt;2.9节选&gt;</code>的每一个调和方法：</p>
<ol>
<li>内部都必定执行了 new FiberNode构造函数</li>
<li>都执行了return 语句；<ul>
<li>这是为将childFiber 返回给 workInProgress.child （也就回传到 <code>&lt;2.6节选&gt;</code> beginWork）;</li>
<li><code>&lt;2.6节选&gt;</code>beginWork 再将 workInProgress.child 返回给了<code>&lt;2.5节选&gt;</code>performUnitOfWork；</li>
<li>在<code>&lt;2.5节选&gt;</code> performUnitOfWork中，因判断next存在值，则继续遍历，形成一个循环；</li>
</ul>
</li>
<li>以上仅是二次总结，避免看到这里的时候，忘记前面的流程，实际上关于这些前面有提及。</li>
</ol>
<h5 id="2-9-6-placeChild"><a href="#2-9-6-placeChild" class="headerlink" title="2.9.6 placeChild"></a>2.9.6 placeChild</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactChildFiber.js</span>

<span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>
    <span class="token parameter">newFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    lastPlacedIndex<span class="token operator">:</span> number<span class="token punctuation">,</span>
    newIndex<span class="token operator">:</span> number<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">&#123;</span>
    newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIndex<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token comment">// current !== null, 表示该节点之前被渲染过   </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> oldIndex <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&lt;</span> lastPlacedIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 一般oldIndex 都大于等于 lastPlacedIndex</span>
        <span class="token comment">// This is a move.              // 但如果节点移动了，则会出现小于的情况</span>
        newFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> Placement<span class="token punctuation">;</span> 
        <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// This item can stay in place.</span>
        <span class="token keyword">return</span> oldIndex<span class="token punctuation">;</span> <span class="token comment">// 如果该节点之前被渲染过，在更新时，正常情况返回旧的index</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// This is an insertion. 打上 新增 的标记</span>
      newFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
      <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span> <span class="token comment">// 常情下 返回 0 ，前置逻辑设置默认为0，这个值在这个方法前没有可以修改的逻辑</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>举个例子说明</p>
<p>假设原来：  01,02 ,03    ====&gt;     现在： 01,03,02 </p>
<ul>
<li><p>01 ==&gt; 执行  return oldIndex ===&gt; 返回 oldIndex = 0</p>
</li>
<li><p>03 ==&gt; 原本index === 2;在第三位，但 2 &gt; 0;  ===&gt; 仍然执行 reuturn oldIndex ===&gt; 返回oldIndex = 2</p>
</li>
<li><p>02 ==&gt; 原本index === 1;在第二位，但 1 &lt; 2;  ===&gt; 触发 oldIndex &lt; lastPlacedIndex ===&gt; 返回 2，newFiber设置为 新增标记</p>
</li>
</ul>
<p>此外按照上述逻辑</p>
<p>如果原来是  1,2,3,4,5,6   ===&gt; 现在 6,5,4,3,2,1</p>
<p>那么 1，2，3，4，5都会被打上 新增的标记</p>
<h5 id="2-9-7-mapRemainingChildren"><a href="#2-9-7-mapRemainingChildren" class="headerlink" title="2.9.7 mapRemainingChildren"></a>2.9.7 mapRemainingChildren</h5><p>简单来说，就是从旧fiber数组的第一位开始，维护一个map集合，</p>
<ul>
<li>如果旧fiber有key，以key作为 map的key</li>
<li>如果旧fiber没有key，以index作为map的key</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>
    <span class="token parameter">returnFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
    currentFirstChild<span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span>string <span class="token operator">|</span> number<span class="token punctuation">,</span> Fiber<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> existingChildren<span class="token operator">:</span> Map<span class="token operator">&lt;</span>string <span class="token operator">|</span> number<span class="token punctuation">,</span> Fiber<span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> existingChild <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>existingChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingChild<span class="token punctuation">.</span>key <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        existingChildren<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>existingChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> existingChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        existingChildren<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>existingChild<span class="token punctuation">.</span>index<span class="token punctuation">,</span> existingChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      existingChild <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> existingChildren<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="2-10-completeUnitOfWork"><a href="#2-10-completeUnitOfWork" class="headerlink" title="2.10 completeUnitOfWork"></a>2.10 completeUnitOfWork</h4><p>回到 <code>&lt;2.5节选&gt;</code> performUnitOfWork ，执行当前方法</p>
<p>*【这是一个从子级到父级的过程】</p>
<ul>
<li>``` html<div>
    <p>
        <span>first</span>
    </p>
    <p>second</p>
    <Thrid />
</div>
<pre class="line-numbers language-none"><code class="language-none">
- 以该DOM结构为参考，理解下方函数

&#96;&#96;&#96; javascript
&#x2F;&#x2F; path: react-reconciler\src\ReactFiberWorkLoop.js

function completeUnitOfWork(unitOfWork: Fiber): Fiber | null &#123;
  &#x2F;&#x2F; 为 workInProgress 全局变量重新赋值
  &#x2F;&#x2F; 第一次执行当前方法时，unitOfWork 是 &lt;span&gt;first&lt;&#x2F;span&gt; 对应的fiber节点  
  workInProgress &#x3D; unitOfWork;
  do &#123;  
    &#x2F;&#x2F; 获取备份节点
    &#x2F;&#x2F; 初始化渲染 非根 Fiber 对象没有备份节点 所以 current 为 null
    const current &#x3D; workInProgress.alternate;
    &#x2F;&#x2F; 父级 Fiber 对象, 非根 Fiber 对象都有父级
    const returnFiber &#x3D; workInProgress.return;
    if ((workInProgress.effectTag &amp; Incomplete) &#x3D;&#x3D;&#x3D; NoEffect) &#123; &#x2F;&#x2F; true
      let next;
   	  &#x2F;&#x2F; 这一段无论如何都要执行  completeWork 方法，因此关于if..else其他的暂时忽略
      &#x2F;&#x2F; 简化一段if...else 其核心是下面这一行【创建节点真实 DOM 对象并将其添加到 stateNode 属性中】
      next &#x3D;  completeWork(current, workInProgress, renderExpirationTime);

      &#x2F;&#x2F; 如果子级存在。至少初始渲染时，是不会进入这一段的
      if (next !&#x3D;&#x3D; null) &#123;
        &#x2F;&#x2F; 返回子级 一直返回到 workLoopSync
        &#x2F;&#x2F; 再重新执行 performUnitOfWork 构建子级 Fiber 节点对象
        return next;
      &#125;
      
      &#x2F;&#x2F; 如果父 Fiber 存在 并且 effectTag 为 0
      if (
        returnFiber !&#x3D;&#x3D; null &amp;&amp;
        (returnFiber.effectTag &amp; Incomplete) &#x3D;&#x3D;&#x3D; NoEffect
      ) &#123;
        &#x2F;&#x2F; 将子树和此 Fiber 的所有副作用附加到父级的 effect 列表上
        &#x2F;&#x2F; 以下两个判断的作用是搜集子 Fiber的 effect 到父 Fiber
        if (returnFiber.firstEffect &#x3D;&#x3D;&#x3D; null) &#123;
          returnFiber.firstEffect &#x3D; workInProgress.firstEffect;
        &#125;

        if (workInProgress.lastEffect !&#x3D;&#x3D; null) &#123;
          if (returnFiber.lastEffect !&#x3D;&#x3D; null) &#123;
            returnFiber.lastEffect.nextEffect &#x3D; workInProgress.firstEffect;
          &#125;
          returnFiber.lastEffect &#x3D; workInProgress.lastEffect;
        &#125;

        &#x2F;&#x2F; 获取副作用标记
        &#x2F;&#x2F; 初始渲染时除[根组件]以外的 Fiber, effectTag 值都为 0, 即不需要执行任何真实DOM操作
        &#x2F;&#x2F; 根组件的 effectTag 值为 3, 即需要将此节点对应的真实DOM对象添加到页面中
        const effectTag &#x3D; workInProgress.effectTag;

        &#x2F;&#x2F; 创建 effect 列表时跳过 NoWork(0) 和 PerformedWork(1) 标记
        &#x2F;&#x2F; 初始渲染时 只有遍历到了根组件 判断条件才能成立, 将 effect 链表添加到 rootFiber
        &#x2F;&#x2F; 初始渲染 FiberRoot 对象中的 firstEffect 和 lastEffect 都是 App 组件
        &#x2F;&#x2F; 因为当所有节点在内存中构建完成后, 只需要一次将所有 DOM 添加到页面中
        if (effectTag &gt; PerformedWork) &#123;
          if (returnFiber.lastEffect !&#x3D;&#x3D; null) &#123; &#x2F;&#x2F; false
            returnFiber.lastEffect.nextEffect &#x3D; workInProgress;
          &#125; else &#123;
            &#x2F;&#x2F; 为 rootFiber 添加 firstEffect
            returnFiber.firstEffect &#x3D; workInProgress;
          &#125;
          &#x2F;&#x2F; 为 root 添加 lastEffect
          returnFiber.lastEffect &#x3D; workInProgress;
        &#125;
      &#125;
    &#125; else &#123;
      &#x2F;&#x2F; 初始渲染不执行
      ...
    &#125;
    const siblingFiber &#x3D; workInProgress.sibling;
    &#x2F;&#x2F; 如果兄弟节点存在，则 reutrn 兄弟节点，用兄弟节点开始下一次的循环
    if (siblingFiber !&#x3D;&#x3D; null) &#123;
      return siblingFiber;
    &#125;
    &#x2F;&#x2F; 否则退回父级 （一直退到 rootFiber时，不再有父级，就打破了循环）
    workInProgress &#x3D; returnFiber;
  &#125; while (workInProgress !&#x3D;&#x3D; null);

  &#x2F;&#x2F; 当执行到这里的时候, 说明遍历到了 root 节点, 已完成遍历
  &#x2F;&#x2F; 更新 workInProgressRootExitStatus 的状态为 已完成
  if (workInProgressRootExitStatus &#x3D;&#x3D;&#x3D; RootIncomplete) &#123;
    workInProgressRootExitStatus &#x3D; RootCompleted;
  &#125;
  return null;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h5 id="2-10-1-completeWork"><a href="#2-10-1-completeWork" class="headerlink" title="2.10.1 completeWork"></a>2.10.1 completeWork</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberCompleteWork.js</span>
<span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 初始时是null</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>  <span class="token comment">// span的fiber</span>
  renderExpirationTime<span class="token punctuation">,</span> <span class="token comment">// Sync</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 获取待更新 props</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  	<span class="token operator">...</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token comment">// 0</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostRoot<span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// 3</span>
      <span class="token function">updateHostContainer</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 5</span>
      <span class="token function">popHostContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> rootContainerInstance <span class="token operator">=</span> <span class="token function">getRootHostContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// div#root 根dom节点</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span> <span class="token comment">// div,span之类的</span>
 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">...</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newProps<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
        <span class="token keyword">const</span> currentHostContext <span class="token operator">=</span> <span class="token function">getHostContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> wasHydrated <span class="token operator">=</span> <span class="token function">popHydrationState</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 服务器渲染相关 初始渲染为不执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wasHydrated<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// false</span>
            <span class="token operator">...</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 创建节点实例对象 &lt;div>&lt;/div> &lt;span>&lt;/span></span>
          <span class="token comment">// 此时的dom实例对象，仍未完全（没有绑定属性，事件等；但已将fiber，props挂了一份在这个对象的某两属性上）</span>
          <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>
            type<span class="token punctuation">,</span>
            newProps<span class="token punctuation">,</span>
            rootContainerInstance<span class="token punctuation">,</span>
            currentHostContext<span class="token punctuation">,</span>
            workInProgress<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/**
           * 将所有的子级追加到父级中
           * instance 为父级
           * workInProgress.child 为子级
           */</span>
          <span class="token function">appendAllChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 为 Fiber 对象添加 stateNode 属性，即stateNode 视同其fiber节点的dom实例</span>
          workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>enableDeprecatedFlareAPI<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// false</span>
            <span class="token operator">...</span>
          <span class="token punctuation">&#125;</span>
          <span class="token operator">...</span><span class="token punctuation">.</span> <span class="token comment">// 初始渲染不执行</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>ref <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">markRef</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// workInProgress.effectTag |= Ref; Ref === 128;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-10-2-createInstance"><a href="#2-10-2-createInstance" class="headerlink" title="2.10.2 createInstance"></a>2.10.2 createInstance</h5><ol>
<li><p>根据 fiber上的type属性创建对应的dom实例</p>
</li>
<li><p>将fiber节点与props挂到 dom实例身上</p>
<p>简单来说：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> ul <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"ul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ul<span class="token punctuation">.</span>props <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
ul<span class="token punctuation">.</span>fiberNode <span class="token operator">=</span> fiberNode<span class="token punctuation">;</span>
<span class="token keyword">return</span> ul<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMHostConfig.js</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>
  type<span class="token operator">:</span> string<span class="token punctuation">,</span>
  props<span class="token operator">:</span> Props<span class="token punctuation">,</span>
  rootContainerInstance<span class="token operator">:</span> Container<span class="token punctuation">,</span>
  hostContext<span class="token operator">:</span> HostContext<span class="token punctuation">,</span>
  internalInstanceHandle<span class="token operator">:</span> Object<span class="token punctuation">,</span> <span class="token comment">// workInProgress 也就是当前fiber对象</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Instance <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>
  <span class="token comment">// 以下代码在 浏览器运行时等同于  document.createElement(type);</span>
  <span class="token keyword">const</span> domElement<span class="token operator">:</span> Instance <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>
    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    rootContainerInstance<span class="token punctuation">,</span>
    parentNamespace<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 等同于 domElement[key] = workInProgress; 即可以通过dom元素找到其对应的fiber节点</span>
  <span class="token function">precacheFiberNode</span><span class="token punctuation">(</span>internalInstanceHandle<span class="token punctuation">,</span> domElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// domElement[key] = props;  </span>
  <span class="token function">updateFiberProps</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> domElement<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-10-3-appendAllChildren"><a href="#2-10-3-appendAllChildren" class="headerlink" title="2.10.3 appendAllChildren"></a>2.10.3 appendAllChildren</h5><p>取当前workInProgress的子级，开启循环</p>
<p>该函数的作用：</p>
<p>​        将上述过程中 创建的stateNode，经过循环，一个一个的挂到父级上；</p>
<p>​        换句话说，即类似于：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">		<span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"ul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

​		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>liList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

​			 <span class="token keyword">const</span> li <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"li"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

​			parent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>

​		<span class="token punctuation">&#125;</span>；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>   *但注意，此时并没有渲染到页面上，只是提前将dom元素创建，与挂到父级上；</p>
<p>   *且单论这个函数：</p>
<ul>
<li>只处理了 workInProgress 的子级一层，并不处理workInProgress.child.child</li>
<li>唯一特殊的是，如果是子级是组件，则取组件的child</li>
</ul>
<p>​    关于该函数，详情如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler/src/ReactFiberCompleteWork.js</span>

<span class="token function-variable function">appendAllChildren</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    parent<span class="token operator">:</span> Instance<span class="token punctuation">,</span> <span class="token comment">// dom实例， 也是当前workInProgress对应的dom实例: span</span>
    workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token comment">// span的fiber</span>
    needsVisibilityToggle<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
    isHidden<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取子级  因为第一次执行 workInProgress是最下层fiber，无有child，所以这个while没走</span>
    <span class="token keyword">let</span> node <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span> 
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 子级存在时</span>
      <span class="token comment">// 如果 node 是普通 ReactElement 或者为文本</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将子级追加到父级中 核心代码：  parent.appendChild(node.stateNode);</span>
        <span class="token function">appendInitialChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> FundamentalComponent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">appendInitialChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果 node 不是普通 ReactElement 又不是文本</span>
        <span class="token comment">// 则表示当前 fiberNode 对应的是一个 组件，组件是不存在 对应dom元素的，需要取它的子级</span>
        <span class="token comment">// 然后继续循环当前逻辑，也就是说，最终要追加完成，上方第一个if是必走的</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 如果 node 和 workInProgress 是同一个节点</span>
      <span class="token comment">// 说明 node 已经退回到父级 终止循环 此时所有子级都已经追加到父级中了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
 	  <span class="token comment">/**
 	   * 如果不存在兄弟节点，
 	   *  此时应当回到父级节点，看父级是否存在兄弟节点
 	   *
 	   * 这里的过程，可以简单理解成： 
 	   *  1. 开始 【子级】
 	   *  2. 【子级的兄弟】
 	   *    2.1 从第二位到倒数第二个都正常循环
 	   *    2.2 【子级的最后一个兄弟】如果其父级不是 workInProgress，则跳到3
 	   *         如果是，则表明此时已经回到了workInProgress.child 这一级且子级都遍历完了
 	   *         可以跳出循环了
 	   *  3. 【父级的兄弟】这里跳回到completeUnitOfWOrk才能看到
 	   *  
 	   *  注意： 这里只执行了workfInProgress的子级一层，关于子级的子级一层，在这里是不可能有的，因为
 	   *      这里的是从底层向上走，而非从上到下
 	   */</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果节点没有父级或者节点的父级是自己, 退出循环</span>
        <span class="token comment">// 说明此时所有子级都已经追加到父级中了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">/**
       * 如果存在兄弟节点，则将 node改成node.sibling继续循环，
       * 同时给兄弟节点设定 return属性指向父级，方便后面能通过兄弟节点回到父级
       */</span>
      node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-11-简记"><a href="#2-11-简记" class="headerlink" title="2.11 简记"></a>2.11 简记</h4><ul>
<li><strong>workLooSync</strong> 开启一个大循环，结束条件是 workInProgress === null</li>
<li><strong>beginWork</strong> 由 rootFiber 开始 ，向下；走到 <strong>ChildReconciler</strong> 构建每一个ReactElement对应的 fiber节点</li>
<li>此时 workInProgress 是最下层的 fiber节点</li>
<li><strong>completeUnitOfWork</strong> 从 最下层开始，向上；经 <strong>createInstance</strong> 为 fiber节点创建stateNode的值（dom实例）；到<strong>appendAllChildren</strong>，将创建好的stateNode往其父级fiber上追加</li>
<li>当向上遍历完成后，workInProgress 就变成了 null</li>
</ul>
<h4 id="2-12-补充"><a href="#2-12-补充" class="headerlink" title="2.12 补充"></a>2.12 补充</h4><h4 id="2-12-1-updateClassComponent"><a href="#2-12-1-updateClassComponent" class="headerlink" title="2.12.1 updateClassComponent"></a>2.12.1 updateClassComponent</h4><h5 id="2-12-1-1-updateClassComponent"><a href="#2-12-1-1-updateClassComponent" class="headerlink" title="2.12.1.1 updateClassComponent"></a>2.12.1.1 updateClassComponent</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  Component<span class="token operator">:</span> any<span class="token punctuation">,</span>
  nextProps<span class="token punctuation">,</span>
  renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>

  <span class="token keyword">let</span> hasContext<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLegacyContextProvider</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    hasContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">pushLegacyContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    hasContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span> <span class="token comment">// class 实例</span>
  <span class="token keyword">let</span> shouldUpdate<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 未创建实例时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 渲染了但没有实例，一般报错情况下会出现</span>
      current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Placement<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// new Component 创建class实例</span>
    <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行willMount周期，执行processUpdateQueue</span>
    <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    shouldUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    shouldUpdate <span class="token operator">=</span> <span class="token function">resumeMountClassInstance</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    shouldUpdate <span class="token operator">=</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> nextUnitOfWork <span class="token operator">=</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    Component<span class="token punctuation">,</span>
    shouldUpdate<span class="token punctuation">,</span>
    hasContext<span class="token punctuation">,</span>
    renderExpirationTime<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> nextUnitOfWork<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-12-1-2-constructClassInstance"><a href="#2-12-1-2-constructClassInstance" class="headerlink" title="2.12.1.2 constructClassInstance"></a>2.12.1.2 constructClassInstance</h5><ul>
<li>new WIP.type(props,context)  即new Class</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberClassComponent.js</span>

<span class="token keyword">function</span> <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>
  <span class="token parameter">workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  ctor<span class="token operator">:</span> any<span class="token punctuation">,</span>
  props<span class="token operator">:</span> any<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> isLegacyContextConsumer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> unmaskedContext <span class="token operator">=</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
  <span class="token comment">// context 相关，暂时跳过</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    context <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>contextType<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disableLegacyContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> contextTypes <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextTypes<span class="token punctuation">;</span>
    isLegacyContextConsumer <span class="token operator">=</span>
      contextTypes <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> contextTypes <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    context <span class="token operator">=</span> isLegacyContextConsumer
      <span class="token operator">?</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span>
      <span class="token operator">:</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Instantiate twice to help detect side-effects.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>
	<span class="token comment">// new 实例  ctor 即Component,也是 wip.type</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctor</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// state = wip.memioizedState = inst.state || null;</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">undefined</span>
      <span class="token operator">?</span> instance<span class="token punctuation">.</span>state
      <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isLegacyContextConsumer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">cacheContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-12-1-3-adoptClassInstance"><a href="#2-12-1-3-adoptClassInstance" class="headerlink" title="2.12.1.3 adoptClassInstance"></a>2.12.1.3 adoptClassInstance</h5><ul>
<li>将instance 赋值给WIP.stateNode</li>
<li>设置classComponentUpdate对象给instance.updater 方便后续调用setState</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">
<span class="token keyword">function</span> <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span><span class="token parameter">workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> instance<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  instance<span class="token punctuation">.</span>updater <span class="token operator">=</span> classComponentUpdater<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>
  <span class="token comment">// The instance needs access to the fiber so that it can schedule updates</span>
  <span class="token comment">// 这一步，本质等同于 instance._reactInternalFiber = workInProgress; 从而方便通过this找到wip</span>
  <span class="token comment">// 在setState中会用到这里挂在 _reactInternalFiber的值</span>
  <span class="token function">setInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-12-1-4-classComponentUpdater"><a href="#2-12-1-4-classComponentUpdater" class="headerlink" title="2.12.1.4 classComponentUpdater"></a>2.12.1.4 classComponentUpdater</h5><p>在class组件中，常常会 通过 <strong>this.setState</strong> 去设置state；而setState是继承自 React.Component.setState的方法，在该方法中，如果看过源码，应该记得，其核心就只有一句：</p>
<p><strong>this.updater.enqueueSetState(this, partialState, callback, ‘setState’);</strong></p>
<p>然而，该enqueueSetState来自哪来呢？</p>
<ul>
<li><p>adoptClassInstance 方法给出了答案；</p>
</li>
<li><p>instance 即 this, instance.updater即 this.updater；</p>
</li>
<li><p>也就是最终指向了 classComponentUpdater</p>
</li>
</ul>
<p><u>简言之： 是 classComponentUpdater 对象，确保了class组件能够真正具有 setState的能力</u></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberClassComponent.js</span>
<span class="token keyword">const</span> classComponentUpdater <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  isMounted<span class="token punctuation">,</span>
  <span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//  别忘了 adoptClassInstance 中执行了 setInstance，才确保这里能执行getInstance</span>
    <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTimeForUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>
      currentTime<span class="token punctuation">,</span>
      fiber<span class="token punctuation">,</span>
      suspenseConfig<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">enqueueReplaceState</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">enqueueForceUpdate</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-12-1-5-mountClassInstance"><a href="#2-12-1-5-mountClassInstance" class="headerlink" title="2.12.1.5 mountClassInstance"></a>2.12.1.5 mountClassInstance</h5><ol>
<li><p>初始化 props.state</p>
</li>
<li><p>创建updateQueue并更新</p>
</li>
<li><p>如果外面定义了  getDerivedStateFromProps 则执行该生命周期；</p>
<p>注意：</p>
<p>当没有定义 getSnapshotBeforeUpdate及 getSnapshotBeforeUpdate 这两个新生命周期时</p>
<p>才会有可能执行 componentWillMount 生命周期</p>
</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberClassComponent.js</span>
<span class="token keyword">function</span> <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>
  <span class="token parameter">workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  ctor<span class="token operator">:</span> any<span class="token punctuation">,</span>
  newProps<span class="token operator">:</span> any<span class="token punctuation">,</span>
  renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>props <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyRefsObject<span class="token punctuation">;</span>

  <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>

  <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>
          workInProgress<span class="token punctuation">,</span>
          ctor<span class="token punctuation">,</span>
          getDerivedStateFromProps<span class="token punctuation">,</span>
          newProps<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
          <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">callComponentWillMount</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If we had additional state updates during this life-cycle, let's</span>
        <span class="token comment">// process them now.</span>
        <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>
          workInProgress<span class="token punctuation">,</span>
          newProps<span class="token punctuation">,</span>
          instance<span class="token punctuation">,</span>
          renderExpirationTime<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-12-1-6-finishClassComponent"><a href="#2-12-1-6-finishClassComponent" class="headerlink" title="2.12.1.6 finishClassComponent"></a>2.12.1.6 finishClassComponent</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberBeginWork.js</span>
<span class="token keyword">function</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  Component<span class="token operator">:</span> any<span class="token punctuation">,</span>
  shouldUpdate<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  hasContext<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  renderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Refs should update even if shouldComponentUpdate returns false</span>
  <span class="token comment">//无论是否更新 props/state，都必须更新 ref 指向</span>
  <span class="token function">markRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断是否有错误捕获</span>
  <span class="token keyword">const</span> didCaptureError <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> DidCapture<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">;</span>
  <span class="token comment">//当不需要更新/更新完毕，并且没有出现 error 的时候</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldUpdate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didCaptureError<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

  <span class="token comment">// Rerender</span>
  ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    didCaptureError <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> Component<span class="token punctuation">.</span>getDerivedStateFromError <span class="token operator">!==</span> <span class="token string">'function'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//如果出现 error且未调用getDerivedStateFromError的话，就中断渲染</span>
    nextChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">stopProfilerTimerIfRunning</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	 <span class="token operator">...</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      nextChildren <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// React DevTools reads this flag.</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> PerformedWork<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> didCaptureError<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//强制重新计算 children，因为当出错时，是渲染到节点上的 props/state 出现了问题，所以不能复用，必须重新 render</span>
    <span class="token function">forceUnmountCurrentAndReconcile</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将 ReactElement 变成fiber对象，并更新，生成对应 DOM 的实例，并挂载到真正的 DOM 节点上</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      nextChildren<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> instance<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">invalidateContextProvider</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//返回 render 下的第一个节点</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/13/16f9c82b8d867dec~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="img"> </p>
<h4 id="2-12-2-updateFunctionComponent"><a href="#2-12-2-updateFunctionComponent" class="headerlink" title="2.12.2 updateFunctionComponent"></a>2.12.2 updateFunctionComponent</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  Component<span class="token punctuation">,</span>
  nextProps<span class="token operator">:</span> any<span class="token punctuation">,</span>
  renderExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">let</span> context<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>disableLegacyContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context <span class="token operator">=</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
  <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token operator">...</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    nextChildren <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      Component<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">,</span>
      context<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didReceiveUpdate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">bailoutHooks</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>
      current<span class="token punctuation">,</span>
      workInProgress<span class="token punctuation">,</span>
      renderExpirationTime<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// React DevTools reads this flag.</span>
  workInProgress<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> PerformedWork<span class="token punctuation">;</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    nextChildren<span class="token punctuation">,</span>
    renderExpirationTime<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-12-2-renderWithHooks"><a href="#2-12-2-renderWithHooks" class="headerlink" title="2.12.2  renderWithHooks"></a>2.12.2  renderWithHooks</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberHooks.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  Component<span class="token operator">:</span> any<span class="token punctuation">,</span>
  props<span class="token operator">:</span> any<span class="token punctuation">,</span>
  secondArg<span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// context</span>
  nextRenderExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">&#123;</span>
  <span class="token comment">// 保存当前要渲染的函数组件对应的fiber，后面执行函数内部的hooksAPI时会用到</span>
  currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
   <span class="token operator">...</span>
  <span class="token comment">// 决定hooks使用mount方式还是update方式</span>
  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>
        current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> HooksDispatcherOnMount
    <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>
 <span class="token comment">// 这里在调用 wip.type()时，内部开发人员会编写 useState,useEffect，而执行到这些hooks api时</span>
 <span class="token comment">// 将调用 ReactCurrentDispatcher.current   </span>
 <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> secondArg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher<span class="token punctuation">;</span>

 currentlyRenderingFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// 重置函数组件中执行工作的hooks，腾出位置，方便给下一个函数组件使用。</span>
 currentHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> children<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于ReactCurrentDispathcer</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> useState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">></span><span class="token punctuation">(</span>
  initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">>></span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> ReactCurrentDispatcher<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="3-commit提交渲染"><a href="#3-commit提交渲染" class="headerlink" title="3 commit提交渲染"></a>3 commit提交渲染</h3><p>此时，退回到 <code>&lt;2.1节选&gt; </code>performSyncWorkOnRoot 方法，开始执行 finishSyncRender 方法，进入commit阶段；</p>
<h4 id="3-1-finishSyncRender"><a href="#3-1-finishSyncRender" class="headerlink" title="3.1 finishSyncRender"></a>3.1 finishSyncRender</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="token keyword">function</span> <span class="token function">finishSyncRender</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// root： fiberRoot对象，</span>
  <span class="token comment">// 销毁 workInProgress Fiber 树</span>
  <span class="token comment">// 因为待提交 Fiber 对象已经被存储在了 root.finishedWork 中</span>
  <span class="token comment">// 可以参考 &lt;2.1节选> 里的 root.finishedWork = root.current.alternate;</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 进入 commit 阶段</span>
  <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-2-commitRoot"><a href="#3-2-commitRoot" class="headerlink" title="3.2 commitRoot"></a>3.2 commitRoot</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 97 获取任务优先级</span>
  <span class="token comment">// 使用最高优先级执行当前任务, 因为 commit 阶段不可以被打断</span>
  <span class="token function">runWithPriority</span><span class="token punctuation">(</span> <span class="token comment">// 与调度有关的方法</span>
    ImmediatePriority<span class="token punctuation">,</span> <span class="token comment">// 99 最高优先级</span>
    <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-3-commitRootImpl"><a href="#3-3-commitRootImpl" class="headerlink" title="3.3 commitRootImpl"></a>3.3 commitRootImpl</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="token comment">/**
 * param &#123;*&#125; root: fiberRoot
 * param &#123;*&#125; renderPriorityLevel: 97
 */</span>
<span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 内有 if (pendingPassiveEffectsRenderPriority !== NoPriority) 此时 90 === 90</span>
    <span class="token comment">// 基于 &lt;3.3.1节选>的App组件案例，这里并没有执行</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"after flushPassiveEffects"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 证明关于生命周期的执行，还不在这</span>
    
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>  <span class="token comment">// rootFiber 对象</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedExpirationTime<span class="token punctuation">;</span>  <span class="token comment">// 1073741823 Snyc</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 重置为默认值</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span> <span class="token comment">// 0</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackExpirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>
  <span class="token operator">...</span>
  
  <span class="token operator">...</span>
  
  <span class="token comment">// 简化后代码如下， 在某种判断情况下 firstEffect =  finishedWork</span>
  <span class="token comment">// 但其本质，是获取DOM操作的链表</span>
  <span class="token keyword">let</span> firstEffect <span class="token operator">=</span>  finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span> 
    
   <span class="token keyword">if</span> <span class="token punctuation">(</span>firstEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>  <span class="token comment">// 8</span>
    executionContext <span class="token operator">|=</span> CommitContext<span class="token punctuation">;</span>   <span class="token comment">// 40</span>
	<span class="token comment">// 翻译： 在调用生命周期之前将其重置为null</span>
    ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// root.containerInfo === div#root   </span>
    <span class="token function">prepareForCommit</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 暂可忽略</span>
       
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token comment">// commit 第一个子阶段</span>
    <span class="token comment">// 处理类组件的 getSnapShotBeforeUpdate 生命周期函数</span>
    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Should be working on an effect.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">recordCommitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取当前次commit时间 类似于new Date()</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// commit 第二个子阶段</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
         <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Should be working on an effect.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
         nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">resetAfterCommit</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    <span class="token comment">// commit 第三个子阶段</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
          <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">invariant</span><span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'Should be working on an effect.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">captureCommitPhaseError</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 重置 nextEffect</span>
    nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">requestPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulerTracing<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">popInteractions</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevInteractions<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>Interaction<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-3-1-do…while的flushPassiveEffects（忽略）"><a href="#3-3-1-do…while的flushPassiveEffects（忽略）" class="headerlink" title="3.3.1 do…while的flushPassiveEffects（忽略）"></a>3.3.1 do…while的flushPassiveEffects（忽略）</h5><p>关于上面 do…while 循环，记录一段demo</p>
<p>声明两种类型的 App 组件，分别打印 执行到 循环之后的打印语句，如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// dmeo1:</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"useEffect"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"useEffect2"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>App works<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// after flushPassiveEffects</span>
<span class="token comment">// useEffect</span>
<span class="token comment">// useEffect2</span>

<span class="token comment">// demo2:</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">&#123;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"componentDidMount"</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>p<span class="token operator">></span>
          <span class="token operator">&lt;</span>p<span class="token operator">></span><span class="token keyword">class</span> <span class="token class-name">component</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
        <span class="token operator">&lt;</span>p<span class="token operator">></span><span class="token number">333</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
        <span class="token operator">&lt;</span>Demo <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// after flushPassiveEffects</span>
<span class="token comment">// componentDidMount</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-3-2-prepareForCommit（忽略）"><a href="#3-3-2-prepareForCommit（忽略）" class="headerlink" title="3.3.2 prepareForCommit（忽略）"></a>3.3.2 prepareForCommit（忽略）</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMHostConfig.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">prepareForCommit</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token operator">:</span> Container</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  eventsEnabled <span class="token operator">=</span> <span class="token function">ReactBrowserEventEmitterIsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
  selectionInformation <span class="token operator">=</span> <span class="token function">getSelectionInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回 聚焦的对象，光标选择的片段等</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"selectionInformation"</span><span class="token punctuation">,</span>selectionInformation<span class="token punctuation">)</span>
  <span class="token function">ReactBrowserEventEmitterSetEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里对第一行获取的__enable 设置为false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-3-3-commit-阶段一"><a href="#3-3-3-commit-阶段一" class="headerlink" title="3.3.3 commit 阶段一"></a>3.3.3 commit 阶段一</h5><blockquote>
<p>阶段一，在初始渲染过程中，并未执行；关于其具体逻辑与打印需结合更新操作来阅读</p>
</blockquote>
<h6 id="3-3-3-1-commitBeforeMutationEffects"><a href="#3-3-3-1-commitBeforeMutationEffects" class="headerlink" title="3.3.3.1 commitBeforeMutationEffects"></a>3.3.3.1 commitBeforeMutationEffects</h6><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 循环 effect 链   nextEffect是在其父函数中用var申明的</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// nextEffect 是 effect 链上从 firstEffect 到 lastEffect的每一个需要commit的 fiber 对象</span>
    <span class="token comment">// 初始化渲染第一个 nextEffect 为 App 组件（render方法的第一个参数）</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span> <span class="token comment">// 3</span>

    <span class="token comment">// Snapshot 和更新有关系；初始化渲染时不执行；3 &amp; 256 === 0 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      
      <span class="token function">recordEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计数 effectCountInCurrentCommit++;</span>
      <span class="token comment">// 获取当前 fiber 节点</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token comment">// 内部判断仅 classComponent 类型的才会执行逻辑</span>
      <span class="token comment">// 取旧props，旧state,传入组件实例的getSnapshotBeforeUpdate 生命周期函数</span>
      <span class="token comment">// nextEffect.getSnapshotBeforeUpdate()  </span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 调度 useEffect</span>
    <span class="token comment">// 初始化渲染 目前没有 不执行</span>
    <span class="token comment">// 3 &amp; 512 === 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// If there are passive effects, schedule a callback to flush at</span>
      <span class="token comment">// the earliest opportunity.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 触发useEffect</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-3-2-commitBeforeMutationEffectOnFiber"><a href="#3-3-3-2-commitBeforeMutationEffectOnFiber" class="headerlink" title="3.3.3.2 commitBeforeMutationEffectOnFiber"></a>3.3.3.2 commitBeforeMutationEffectOnFiber</h6><p>更新流程中：</p>
<p>​    将 fiber 节点的之前的state和props作为入参；</p>
<p>​    触发 组件实例的 getSnapshotBeforeUpdate 生命周期；</p>
<p>getSnapshotBeforeUpdate：</p>
<p>​     获取<code>更新前</code>的<code>state,props</code>对象（快照）</p>
<p>​     <a target="_blank" rel="noopener" href="https://www.runoob.com/react/react-ref-getsnapshotbeforeupdate.html">https://www.runoob.com/react/react-ref-getsnapshotbeforeupdate.html</a></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberCommitWork.js</span>
<span class="token keyword">function</span> <span class="token function">commitBeforeMutationLifeCycles</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  finishedWork<span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>  
    <span class="token keyword">case</span> Block<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 如果该 fiber 类型是 ClassComponent</span>
    <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"commitBeforeMutationLifeCycles"</span><span class="token punctuation">,</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span> <span class="token comment">// 旧的 props；若是新的，则pendingProps</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span> <span class="token comment">// 旧的 state</span>
          <span class="token comment">// 获取 classComponent 组件的实例对象</span>
          <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
          
          <span class="token comment">// 执行 getSnapshotBeforeUpdate 生命周期函数</span>
          <span class="token comment">// 在组件更新前捕获一些 DOM 信息</span>
          <span class="token comment">// 返回自定义的值或 null, 统称为 snapshot</span>
          <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>
            finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> prevProps
              <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
            prevState<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 实例对象上记录 该生命周期的返回值</span>
          instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token operator">=</span> snapshot<span class="token punctuation">;</span>
          <span class="token function">stopPhaseTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-3-4-commit-阶段二"><a href="#3-3-4-commit-阶段二" class="headerlink" title="3.3.4 commit 阶段二"></a>3.3.4 commit 阶段二</h5><p>执行DOM操作</p>
<h6 id="3-3-4-1-commitMutationEffects"><a href="#3-3-4-1-commitMutationEffects" class="headerlink" title="3.3.4.1 commitMutationEffects"></a>3.3.4.1 commitMutationEffects</h6><p>根据fiber节点的effectTag决定当前fiber节点执行什么类型的操作（插入，更新，删除）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 循环 effect 链</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 文本节点时，此时将其textCotent 置空  </span>
      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ref = null</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 根据 effectTag 分别处理</span>
    <span class="token keyword">let</span> primaryEffectTag <span class="token operator">=</span>
      effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始渲染 primaryEffectTag 为 2 匹配到 Placement</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 针对该节点及子节点进行插入操作</span>
      <span class="token keyword">case</span> Placement<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// effectTag 从 3 变为 1</span>
        <span class="token comment">// 从 effect 标签中清除 "placement" 重置 effectTag 值</span>
        <span class="token comment">// 以便我们知道在调用诸如componentDidMount之类的任何生命周期之前已将其插入。</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 插入并更新 DOM</span>
      <span class="token keyword">case</span> PlacementAndUpdate<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 插入</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextEffect<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
        <span class="token comment">// 更新</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token operator">...</span>
  
      <span class="token comment">// 更新 DOM</span>
      <span class="token keyword">case</span> Update<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 删除 DOM</span>
      <span class="token keyword">case</span> Deletion<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">recordEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-4-2-commitPlacement"><a href="#3-3-4-2-commitPlacement" class="headerlink" title="3.3.4.2 commitPlacement"></a>3.3.4.2 commitPlacement</h6><p>在第一次调用当前函数时，由前置逻辑<code>&lt;3.3节选&gt;</code>可以知道：</p>
<p>​    nextEffect = firstEffect = finishedWork</p>
<p>也就是指，此时的 finishedWork 指的时 Class App fiber节点（ReactDOM.render的第一个参数对应的fiber）而非 rootFiber</p>
<ol>
<li>取 finishedWork 的 非组件父级fiber节点，与该父级fiber节点对应DOM节点</li>
<li>取 finishedWork 的兄弟fiber节点</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberCommitWork.js</span>

<span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// finishedWork 初始化渲染时为 firstEffect，也就是class App,render方法的第一个参数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsMutation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 获取非组件父级 Fiber 对象</span>
  <span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一次是 rootFiber</span>
  <span class="token keyword">let</span> parent<span class="token punctuation">;</span> <span class="token comment">// 父级对应的真实DOM节点 （stateNode）</span>
  <span class="token comment">// 是否为渲染容器</span>
  <span class="token comment">// 渲染容器和普通react元素的主要区别在于是否需要特殊处理注释节点</span>
  <span class="token keyword">let</span> isContainer<span class="token punctuation">;</span>
  <span class="token comment">// 获取父级 DOM 节点对象</span>
  <span class="token comment">// 初始渲染时 rootFiber 对象中的 stateNode 是 FiberRoot</span>
  <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token comment">// 判断父节点的类型，初始渲染时是 hostRoot 3</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
      parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
      isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
      parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span> <span class="token comment">// 获取 DOM 节点，div#root</span>
      isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">// 是 container 容器</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
      parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
      isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> FundamentalComponent<span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
 
  <span class="token operator">...</span>

  <span class="token comment">// 查看当前节点是否有下一个兄弟节点</span>
  <span class="token comment">// 有, 执行 insertBefore</span>
  <span class="token comment">// 没有, 执行 appendChild</span>
  <span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 向父节点中追加节点 或者 将子节点插入到 before 节点的前面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 容器</span>
    <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 非渲染容器</span>
    <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-4-3-getHostParentFiber"><a href="#3-3-4-3-getHostParentFiber" class="headerlink" title="3.3.4.3 getHostParentFiber"></a>3.3.4.3 getHostParentFiber</h6><p>递归查找当前fiber节点的父级非组件节点</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//path: react-reconciler\src\ReactFiberCommitWork.js</span>

<span class="token keyword">function</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//  fiber.tag === HostComponent || fiber.tag === HostRoot || fiber.tag === HostPortal</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHostParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-4-4-insertOrAppendPlacementNodeIntoContainer"><a href="#3-3-4-4-insertOrAppendPlacementNodeIntoContainer" class="headerlink" title="3.3.4.4 insertOrAppendPlacementNodeIntoContainer"></a>3.3.4.4 insertOrAppendPlacementNodeIntoContainer</h6><p>根据before判断，是调用 insertBefore方法还是appendChild方法</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberCommitWork.js</span>

<span class="token keyword">function</span> <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>
  node<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token comment">// 当前需要执行插入的fiber节点</span>
  before<span class="token operator">:</span> <span class="token operator">?</span>Instance<span class="token punctuation">,</span> <span class="token comment">// node.sibling，经打印发现 初始渲染时，before是null</span>
  parent<span class="token operator">:</span> Container<span class="token punctuation">,</span> <span class="token comment">// node.parent</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>tag<span class="token punctuation">&#125;</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token comment">// 如果待插入的节点是一个 DOM 元素或者文本的话,为true；如果是组件fiber节点的话，为false</span>
  <span class="token comment">// 比如 组件fiber => false div => true</span>
  <span class="token keyword">const</span> isHost <span class="token operator">=</span> tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> tag <span class="token operator">===</span> HostText<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHost <span class="token operator">||</span> <span class="token punctuation">(</span>enableFundamentalAPI <span class="token operator">&amp;&amp;</span> tag <span class="token operator">===</span> FundamentalComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取 DOM 节点</span>
    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> isHost <span class="token operator">?</span> node<span class="token punctuation">.</span>stateNode <span class="token operator">:</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 插入到 before 前面  parent.insertBefore(stateNode,before);</span>
      <span class="token function">insertInContainerBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 追加到父容器中  parent.appendChild(stateNode);</span>
      <span class="token function">appendChildToContainer</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 如果是组件节点, 比如 ClassComponent, 则找它的第一个子节点(DOM 元素)进行插入操作</span>
      
    <span class="token comment">// TODO: 有一个疑问，为什么是insertBefore</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 向父级中追加子节点或者将子节点插入到 before 的前面</span>
      <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取下一个兄弟节点</span>
      <span class="token keyword">let</span> sibling <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token comment">// 如果兄弟节点存在</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>sibling <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 向父级中追加子节点或者将子节点插入到 before 的前面</span>
        <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>sibling<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sibling <span class="token operator">=</span> sibling<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-4-5-insertInContainerBefore"><a href="#3-3-4-5-insertInContainerBefore" class="headerlink" title="3.3.4.5 insertInContainerBefore"></a>3.3.4.5 insertInContainerBefore</h6><p>本质等同于 insertBefore</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMHostConfig.js</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">insertInContainerBefore</span><span class="token punctuation">(</span>
  <span class="token parameter">container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
  child<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">,</span>
  beforeChild<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance <span class="token operator">|</span> SuspenseInstance<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 如果父容器是注释节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 找到注释节点的父级节点 因为注释节点没法调用 insertBefore</span>
    <span class="token punctuation">(</span>container<span class="token punctuation">.</span>parentNode<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> beforeChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将 child 插入到 beforeChild 的前面</span>
    container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> beforeChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-4-6-appendChildToContainer"><a href="#3-3-4-6-appendChildToContainer" class="headerlink" title="3.3.4.6 appendChildToContainer"></a>3.3.4.6 appendChildToContainer</h6><p>本质等同于 appendChild</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-dom\src\client\ReactDOMHostConfig.js</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">appendChildToContainer</span><span class="token punctuation">(</span>
  <span class="token parameter">container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
  child<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 监测 container 是否注释节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">COMMENT_NODE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取父级的父级</span>
    parentNode <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>parentNode<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将子级节点插入到注释节点的前面</span>
    parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 直接将 child 插入到父级中</span>
    parentNode <span class="token operator">=</span> container<span class="token punctuation">;</span>
    parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-3-5-commit-阶段三"><a href="#3-3-5-commit-阶段三" class="headerlink" title="3.3.5 commit 阶段三"></a>3.3.5 commit 阶段三</h5><p>每一个commit阶段，都是从firstEffect开始执行do…while循环；</p>
<p>等同于对 effects 执行了三遍循环，每一次的循环执行的目的不一而已</p>
<p>简言之，阶段三负责以下事务：</p>
<ol>
<li><p>执行生命周期函数</p>
</li>
<li><p>赋值 ref </p>
</li>
<li><p>执行 callback 函数</p>
<hr>
</li>
</ol>
<p>!!! 注意 关于 componentWillMount 函数的调用应当回到 <code>&lt;2.6节选&gt;</code>中去看 以update开头的函数名指向的方法</p>
<h6 id="3-3-5-1-commitLayoutEffects"><a href="#3-3-5-1-commitLayoutEffects" class="headerlink" title="3.3.5.1 commitLayoutEffects"></a>3.3.5.1 commitLayoutEffects</h6><ul>
<li>执行生命周期函数</li>
<li>调用 ref 函数，回传 stateNode 作为入参（这里的 ref 或是fn, 或是useRef声明的）</li>
<li>递归 nextEffect 链</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>
  <span class="token parameter">root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  committedExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 此时 effectTag 已经被重置为 1, 表示 DOM 操作已经完成</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
    <span class="token comment">// 执行生命周期函数和钩子函数; 前提： 有定义 callback 或useEffect 或生命周期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Update <span class="token operator">|</span> Callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">recordEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token comment">// 类组件处理生命周期函数</span>
      <span class="token comment">// 函数组件处理 useEffect 钩子函数</span>
      <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>
        root<span class="token punctuation">,</span>
        current<span class="token punctuation">,</span>
        nextEffect<span class="token punctuation">,</span>
        committedExpirationTime<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 赋值ref</span>
    <span class="token comment">// false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">recordEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 更新循环条件</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-5-2-commitLayoutEffectOnFiber"><a href="#3-3-5-2-commitLayoutEffectOnFiber" class="headerlink" title="3.3.5.2 commitLayoutEffectOnFiber"></a>3.3.5.2 commitLayoutEffectOnFiber</h6><p>根据 当前fiber节点的tag，区分fiber对应类型是组件的，或者html标签的等；进而判断其是否定义了生命周期，然后执行</p>
<p>简单来说就是 执行 componentDidMount, useEffect</p>
<p>或 componentDidUpdate ， useEffect</p>
<p>!!! 当前函数要执行的前提是： 当前的 fiber 节点对应的实例上 有定义 声明周期或者 callback 函数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberCommitWork.js</span>

<span class="token keyword">function</span> <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span>
  finishedRoot<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  finishedWork<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token comment">// nextEffect </span>
  committedExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span>
    <span class="token keyword">case</span> ForwardRef<span class="token operator">:</span>
 	<span class="token operator">...</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>HookLayout <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token operator">...</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span> <span class="token comment">// 比如App组件的实例</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>effectTag <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 当组件中定义了生命周期函数时时</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 初始渲染阶段</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 调用 componentDidMount 生命周期函数</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>              <span class="token comment">// 更新阶段</span>
          <span class="token comment">// 获取旧的 props</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span>
            finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps
              <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 获取旧的 state</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
          <span class="token comment">// 调用 componentDidUpdate 生命周期函数</span>
          <span class="token comment">// instance.__reactInternalSnapshotBeforeUpdate 快照</span>
          <span class="token comment">// getSnapShotBeforeUpdate 方法的返回值</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>
            prevProps<span class="token punctuation">,</span>
            prevState<span class="token punctuation">,</span>
            instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 获取任务队列</span>
      <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
      <span class="token comment">// 如果任务队列存在</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      	<span class="token operator">...</span> 
        <span class="token comment">/**
         * 调用 ReactElement 渲染完成之后的回调函数  即 render 方法的第三个参数
         */</span>
        <span class="token function">commitUpdateQueue</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> updateQueue<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  
   	<span class="token operator">...</span>
   
    <span class="token keyword">case</span> HostText<span class="token operator">:</span>
    <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
   	<span class="token operator">...</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-5-3-commitUpdateQueue"><a href="#3-3-5-3-commitUpdateQueue" class="headerlink" title="3.3.5.3 commitUpdateQueue"></a>3.3.5.3 commitUpdateQueue</h6><p>fiber.tag 为 HostRoot，ClassComponent 的，才执行本函数</p>
<p>当前函数的本质即是 执行 callback 函数（ReactDOM.render 方法传入的第三个参数）</p>
<p>一般正常开发项目中，很少定义 callback ，也就不会进入 if 代码块</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactUpdateQueue.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> commitUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">(</span>
  finishedWork<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  finishedQueue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// finishedWork.updaeQueue</span>
  instance<span class="token operator">:</span> any<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// effects 为数组, 存储任务对象 (Update 对象)</span>
  <span class="token comment">// 但前提是在调用 render 方法时传递了回调函数, 就是 render 方法的第三个参数</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> finishedQueue<span class="token punctuation">.</span>effects<span class="token punctuation">;</span> <span class="token comment">// fiber.updateQueue.effects</span>
  <span class="token comment">// 重置 finishedQueue.effects 数组</span>
  finishedQueue<span class="token punctuation">.</span>effects <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果传递了 render 方法的第三个参数, effect 数组就不会为 null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 遍历 effect 数组</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> effects<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 获取数组中的第 i 个需要执行的 effect</span>
      <span class="token keyword">const</span> effect <span class="token operator">=</span> effects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取 callback 回调函数</span>
      <span class="token keyword">const</span> callback <span class="token operator">=</span> effect<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
      <span class="token comment">// 如果回调函数不为 null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 清空 effect 中的 callback</span>
        effect<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行回调函数</span>
        <span class="token function">callCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-5-4-commitHookEffectListMount"><a href="#3-3-5-4-commitHookEffectListMount" class="headerlink" title="3.3.5.4 commitHookEffectListMount"></a>3.3.5.4 commitHookEffectListMount</h6><p>这里执行的是 当fiber 是fn组件时，且定义了useEffect才会执行的函数</p>
<p>firstEffect =&gt; nextEffect =&gt; nextEffect =&gt; lastEffect =&gt; firstEffect</p>
<p>通过next属性，可以找到下一个副作用，而lastEffect.next  === firstEffect</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">destroy</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    next<span class="token operator">:</span> nextEffect<span class="token punctuation">,</span>
    deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">&#125;</span>
    
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 这个是create</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment">// 这是destory</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">/* 这是deps */</span> <span class="token punctuation">)</span>     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// path: react-reconciler\src\ReactFiberCommitWork.js</span>
<span class="token keyword">function</span> <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token operator">:</span> number<span class="token punctuation">,</span> finishedWork<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 获取任务队列</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token comment">// 获取 lastEffect</span>
  <span class="token keyword">let</span> lastEffect <span class="token operator">=</span> updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> updateQueue<span class="token punctuation">.</span>lastEffect <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果 lastEffect 不为 null</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取要执行的副作用</span>
    <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token comment">// 通过遍历的方式调用 useEffect 中的回调函数</span>
    <span class="token comment">// 在组件中定义了调用了几次 useEffect 遍历就会执行几次</span>
    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> tag<span class="token punctuation">)</span> <span class="token operator">===</span> tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Mount</span>
        <span class="token keyword">const</span> create <span class="token operator">=</span> effect<span class="token punctuation">.</span>create<span class="token punctuation">;</span> <span class="token comment">// create 就是 useEffect 方法的第一个参数</span>
        effect<span class="token punctuation">.</span>destroy <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 返回值就是清理函数</span>
        <span class="token operator">...</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 更新循环条件</span>
      effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="3-3-5-5-commitAttachRef"><a href="#3-3-5-5-commitAttachRef" class="headerlink" title="3.3.5.5 commitAttachRef"></a>3.3.5.5 commitAttachRef</h6><p>判断，如果定义了ref属性的话： 将 stateNode 返回出去</p>
<blockquote>
<p>由于是 <strong>stateNode</strong>，也就是说：</p>
<p>如果外面是写在 div等标签上的ref，其值为 真实的div DOM节点；</p>
<p>如果外面是写在 Fn,Class上的ref，其值为对应的 fn 经过forward包装的 或 class  实例</p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">commitAttachRef</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">let</span> instanceToUse<span class="token punctuation">;</span>
    <span class="token comment">// 这里的 getPublicInstance 等同于 return instance </span>
    <span class="token comment">// 也就是说，当前react源码版本中，这里的switch..case 可以简化成：</span>
    <span class="token comment">// const instanceToUse = instance  </span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
        instanceToUse <span class="token operator">=</span> <span class="token function">getPublicInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        instanceToUse <span class="token operator">=</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableScopeAPI <span class="token operator">&amp;&amp;</span> finishedWork<span class="token punctuation">.</span>tag <span class="token operator">===</span> ScopeComponent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      instanceToUse <span class="token operator">=</span> instance<span class="token punctuation">.</span>methods<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ref <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">ref</span><span class="token punctuation">(</span>instanceToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      ref<span class="token punctuation">.</span>current <span class="token operator">=</span> instanceToUse<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>commitRootImpl 后续逻辑可以暂不关注</p>
<h2 id="updateQueue"><a href="#updateQueue" class="headerlink" title="updateQueue"></a>updateQueue</h2><h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><p>关于 updateQueue 的一些简单整理：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> type Update<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">|</span>
  tag<span class="token operator">:</span> <span class="token number">0</span> <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">3</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> any<span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> mixed<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  expirationTime<span class="token punctuation">,</span>
  suspenseConfig<span class="token punctuation">,</span>
  next<span class="token operator">:</span> Update<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <code>Update</code> 对象创建后，会通过 <code>enqueueUpdate</code> 函数，挂载到 <code>Fiber</code> 的 <code>updateQueue</code> 中 </p>
<p>而 <code>updateEffect</code>如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> type UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">|</span>
  baseState<span class="token operator">:</span> State<span class="token punctuation">,</span>  <span class="token comment">// 先前的状态，作为 payload 函数的 prevState 参数</span>
  baseQueue<span class="token operator">:</span> Update<span class="token operator">&lt;</span>State<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 存储执行中的更新任务 Update 队列，尾节点存储形式</span>
  shared<span class="token operator">:</span> SharedQueue<span class="token operator">&lt;</span>State<span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 以 pending 属性存储待执行的更新任务 Update 队列，尾节点存储形式</span>
  effects<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Update<span class="token operator">&lt;</span>State<span class="token operator">>></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// commit 阶段执行</span>
<span class="token operator">|</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="enqueueUpdate"><a href="#enqueueUpdate" class="headerlink" title="enqueueUpdate"></a>enqueueUpdate</h3><p>关于 enqueueUpdate 具体方法，在上方<code>&lt;节选 1.10 &gt;</code>有摘抄：</p>
<p> 关键词： 环形链表， 1，2，3，4 ===&gt; 4，1，2，3</p>
<hr>
<p> 在react渲染流程中，当为<strong>hostroot</strong>或者 <strong>classComponent</strong>时，会调用  <strong>processUpdateQueue</strong> ；【y一者在updateHostRoot,一者在updateClassComponent/mountClassInstance】</p>
<hr>
<h3 id="processUpdateQueue"><a href="#processUpdateQueue" class="headerlink" title="processUpdateQueue"></a>processUpdateQueue</h3><p>关于  processUpdateQueue ，</p>
<ol>
<li><p>合并 updateQueue中的baseQueue和pendingQueue，完了后置空pendingQueue</p>
</li>
<li><p>遍历第一步合并后的baseQueue，看每一个update的优先级，滤出要延迟执行的update，组出新的baseQueue，并同时创建effects数组</p>
<p>一旦循环中某个出现需要延迟，在它之后的都必须要放入延迟队列中</p>
</li>
<li><p>只有不存在需要延迟的update，才会将newState给 wip.updateQueue.baseState，否则就是给 wip.memoizedState</p>
</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">path<span class="token operator">:</span> react<span class="token operator">-</span>dom\umd\react<span class="token operator">-</span>dom<span class="token punctuation">.</span>development<span class="token punctuation">.</span>js

<span class="token keyword">function</span> <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span><span class="token parameter">workInProgress<span class="token punctuation">,</span> props<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> renderExpirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> <span class="token punctuation">&#123;</span> baseQueue<span class="token punctuation">,</span> shared <span class="token punctuation">&#125;</span> <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token keyword">var</span> pendingQueue <span class="token operator">=</span> shared<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
    
  <span class="token comment">// 合并 baseQueue，pendingQueue</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
  	  <span class="token keyword">if</span> <span class="token punctuation">(</span>baseQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		 <span class="token comment">// 假设 baseQueue 是 3，1，2  pendingQueue 是 6，4，5</span>
         <span class="token comment">// 那么经过这里的方法，最后得出  3,4,5,6,1,2</span>
        <span class="token keyword">var</span> baseFirst <span class="token operator">=</span> baseQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span> 
        <span class="token keyword">var</span> pendingFirst <span class="token operator">=</span> pendingQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        baseQueue<span class="token punctuation">.</span>next <span class="token operator">=</span> pendingFirst<span class="token punctuation">;</span> 
        pendingQueue<span class="token punctuation">.</span>next <span class="token operator">=</span> baseFirst<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 再经过这一步，进一步变成 6,1,2,3,4,5</span>
      baseQueue <span class="token operator">=</span> pendingQueue<span class="token punctuation">;</span>
      queue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
      <span class="token comment">// 然后判断， WIP.alternate.updateQueue 是否存在，存在则：</span>
      <span class="token constant">WIP</span><span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>baseQueue <span class="token operator">=</span> pendingQueue<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 在上面已经将baseQueue = pendingQueue变成了当前函数体内的最外层变量  </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>baseQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   	<span class="token comment">// 取 baseQueue.next 也就是： 1</span>
    <span class="token keyword">var</span> first <span class="token operator">=</span> baseQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newState <span class="token operator">=</span> queue<span class="token punctuation">.</span>baseState<span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseQueueFirst <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> newBaseQueueLast <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>first <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> update <span class="token operator">=</span> first<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>    
           <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                如果update的优先级不够高，
                <span class="token number">1.</span> 创建一个clone对象，浅拷贝update <span class="token punctuation">[</span>这时的clone对象，next值为<span class="token keyword">null</span><span class="token punctuation">]</span>
                <span class="token number">2.</span> 用 newBaseQueueFirst 保留整条链， 用 newBaseQueueLast 只指向最后一个
                <span class="token number">3.</span> 如设：<span class="token number">6</span>，<span class="token number">1</span>，<span class="token number">2</span>，<span class="token number">3</span>，<span class="token number">4</span>起步：  那么在newBaseQueueFirst 中可以看到 <span class="token number">1</span>，<span class="token number">2</span>，<span class="token number">3</span>，<span class="token number">4</span>
                   newBaseQueueLast <span class="token operator">=</span> <span class="token number">4</span> 且 newBaseQueueLast<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newBaseQueueLast <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 这里的clone与上面的if里的基本一致，但 expirationTime属性</span>
                    <span class="token comment">// 在上面用的update的，在这里单独给了一个值；</span>
                    <span class="token comment">// _clone.expirationTime =  Sync,</span>
                    newBaseQueueLast <span class="token operator">=</span> newBaseQueueLast<span class="token punctuation">.</span>next <span class="token operator">=</span> _clone<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                 newState <span class="token operator">=</span> <span class="token function">getStateFromUpdate</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> update<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> props<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				  queue<span class="token punctuation">.</span>effects <span class="token operator">=</span> queue<span class="token punctuation">.</span>effects <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token operator">...</span>queue<span class="token punctuation">.</span>effect<span class="token punctuation">,</span>update<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>update<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 保证整条链循环</span>
            update <span class="token operator">=</span> update<span class="token punctuation">.</span>next <span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>update <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> update <span class="token operator">===</span> first<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 由于链是环形的，</span>
                <span class="token comment">// 所以判断，如果回到了开始的地方，则需要判断跳出循环</span>
                pendingQueue <span class="token operator">=</span> queue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
					
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                  当前的 queue 处理完后，需要检查一下 queue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending 是否有更新
         		  有则把剩余的 update 都推入到 newBaseQueueLast
                <span class="token punctuation">&#125;</span>
           <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>  
    判断newBaseQueueLast是否是 <span class="token keyword">null</span>，如果判断成立，则将上面的newSatae给到newBaseState
    此外： 当判断成立时，这意味着在上面的循环中，是没有update需要被延迟处理的
    否则： newBaseQueueLast<span class="token punctuation">.</span>next <span class="token operator">=</span> newBaseQueueFirst 将链构成环形
    
    queue<span class="token punctuation">.</span>baseState <span class="token operator">=</span> newBaseState<span class="token punctuation">;</span>
    queue<span class="token punctuation">.</span>baseQueue <span class="token operator">=</span> newBaseQueueLast<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="流程简图"><a href="#流程简图" class="headerlink" title="流程简图"></a>流程简图</h2><p>（本流程简图仅限 render方法到初次渲染完成，未考虑 diff对比）</p>
<p>TIP: 以上是初次调试源码后统合整理的资料，还有很多细节及流程仍未梳理清楚</p>
<p><img src="/images/react/ReactDOM.render.png" alt="1616311309865"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904046403272717">https://juejin.cn/post/6844904046403272717</a> 【updateClassComponent】</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1546880?from=article.detail.1398858">https://cloud.tencent.com/developer/article/1546880?from=article.detail.1398858</a> 【updateFncCom】</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>书生
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/2022/10/03/study/front/frame/react/render/" title="React.render的第一次研究">http://example.com/2022/10/03/study/front/frame/react/render/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%89%8D%E7%AB%AF%EF%BC%9AReact/" rel="tag"># 前端：React</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/11/study/front/javascript/wang_editor_drop/" rel="prev" title="拖拽插入文本到wangEditor中">
                  <i class="fa fa-chevron-left"></i> 拖拽插入文本到wangEditor中
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/10/03/study/front/interest/rc_component_library/" rel="next" title="学习搭建React组件库">
                  学习搭建React组件库 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">书生</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="/js/canvas-nest.js"></script>


    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body>
</html>
